<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>5. Function fitting and Interpolation</title>
    
    <link rel="stylesheet" href="../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> 
  </head>
  <body>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../Chapter6_ENVI/envi.html" title="ENVI"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../Chapter4_GDAL/answers.html" title="Exercise 4.1"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">geogg122</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="function-fitting-and-interpolation">
<h1>5. Function fitting and Interpolation</h1>
<p>In today&#8217;s session, we will be using some of the LAI datasets we
examined last week (masked by national boundaries) and doing some
analysis on them.</p>
<ul class="simple">
<li><a class="reference external" href="#5.1-Making-3D-datasets-and-Movies">5.1 Making 3D datasets and
Movies</a> First, we will examine
how to improve our data reading function by extracting only the area
we are interested in. This involves querying the &#8216;country&#8217; mask to
find its limits and passing this information through to the reader.</li>
<li><a class="reference external" href="#5.2-Interpolation">5.2 Interpolation</a> Then we will look at
methods to interpolate and smooth over gaps in datasets using various
methods.</li>
<li><a class="reference external" href="#5.3-Function-fitting">5.3 Function Fitting</a> Finally, we will
look at fitting models to datasets, in this case a model describing
LAI phenology.</li>
</ul>
<div class="section" id="making-3d-datasets-and-movies">
<h2>5.1 Making 3D datasets and Movies</h2>
<p>First though, we will briefly go over once more the work we did on
downloading data (ussssing <tt class="docutils literal"><span class="pre">wget</span></tt>), generating 3D masked datasets, and
making movies.</p>
<p>This time, we will concentrate more on generating functions that we can
re-use for other purposes.</p>
<div class="section" id="downloading-data">
<h3>5.1.1 Downloading data</h3>
<p>We start by filtering the file <tt class="docutils literal"><span class="pre">files/data/robot.txt</span></tt> to get only
lines (containing urls) for a particular tile and year.</p>
<p>We might easily do this in unix:</p>
<div class="code python highlight-python"><div class="highlight"><pre># filter LAI MODIS files for this year and tile (in bash)
tile=&#39;h17v03&#39;
year=&#39;2005&#39;
ofile=files/data/modis_lai_${tile}_${year}.txt

grep $tile &lt; files/data/robot.txt | grep \/$year &gt; $ofile

# have a look at the first few
head -4 &lt; $ofile
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>http://e4ftl01.cr.usgs.gov/MODIS_Composites/MOTA/MCD15A2.005/2005.01.01/MCD15A2.A2005001.h17v03.005.2007350235547.hdf
http://e4ftl01.cr.usgs.gov/MODIS_Composites/MOTA/MCD15A2.005/2005.01.09/MCD15A2.A2005009.h17v03.005.2007351235445.hdf
http://e4ftl01.cr.usgs.gov/MODIS_Composites/MOTA/MCD15A2.005/2005.01.17/MCD15A2.A2005017.h17v03.005.2007352033411.hdf
http://e4ftl01.cr.usgs.gov/MODIS_Composites/MOTA/MCD15A2.005/2005.01.25/MCD15A2.A2005025.h17v03.005.2007353055037.hdf
</pre></div>
</div>
<p>Now download the datasets:</p>
<div class="code python highlight-python"><div class="highlight"><pre>tile=&#39;h17v03&#39;
year=&#39;2005&#39;
ofile=files/data/modis_lai_${tile}_${year}.txt

# go into the directory we want the data
pushd files/data
# get the urls from the file
# --cut-dirs=4 this time as there are 4 laters of directory we
# wish to ignore with this dataset
wget --quiet -nc -nH --cut-dirs=4 -i ../$ofile
# go back to where we were
popd
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>/archive/rsu_raid_0/plewis/public_html/geogg122_local/geogg122/Chapter5_Interpolation/files/data /archive/rsu_raid_0/plewis/public_html/geogg122_local/geogg122/Chapter5_Interpolation
/archive/rsu_raid_0/plewis/public_html/geogg122_local/geogg122/Chapter5_Interpolation
</pre></div>
</div>
</div>
<div class="section" id="read-from-an-ascii-file">
<h3>5.1.2 Read from an ASCII file</h3>
<p>The ASCII file <tt class="docutils literal"><span class="pre">files/data/modis_lai_${tile}_${year}.txt</span></tt> contains
lines of urls.</p>
<p>Each line (each url) is a string such as:</p>
<p><tt class="docutils literal"><span class="pre">http://e4ftl01.cr.usgs.gov/MODIS_Composites/MOTA/MCD15A2.005/2005.01.25/MCD15A2.A2005025.h17v03.005.2007353055037.hdf</span></tt></p>
<p>The <em>filename</em> here is
<tt class="docutils literal"><span class="pre">MCD15A2.A2005025.h17v03.005.2007353055037.hdf</span></tt>, so we can split the
url on the field <tt class="docutils literal"><span class="pre">/</span></tt> to get this:</p>
<p>Let&#8217;s read the filenames from the text file that has the urls in it and
load it into a list that we will call <tt class="docutils literal"><span class="pre">filelist</span></tt>:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">tile</span> <span class="o">=</span> <span class="s">&#39;h17v03&#39;</span>
<span class="n">year</span> <span class="o">=</span> <span class="s">&#39;2005&#39;</span>

<span class="c"># specify the file with the urls in</span>
<span class="n">ifile</span><span class="o">=</span> <span class="s">&#39;files/data/modis_lai_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">.txt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>

<span class="c"># one way to read the data from the file</span>
<span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="n">filelist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">filelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c"># show the first few</span>
<span class="k">print</span> <span class="n">filelist</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="s">&#39;MCD15A2.A2005001.h17v03.005.2007350235547.hdf&#39;</span><span class="p">,</span> <span class="s">&#39;MCD15A2.A2005009.h17v03.005.2007351235445.hdf&#39;</span><span class="p">,</span> <span class="s">&#39;MCD15A2.A2005017.h17v03.005.2007352033411.hdf&#39;</span><span class="p">,</span> <span class="s">&#39;MCD15A2.A2005025.h17v03.005.2007353055037.hdf&#39;</span><span class="p">,</span> <span class="s">&#39;MCD15A2.A2005033.h17v03.005.2007355050158.hdf&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># a neater way:</span>
<span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
<span class="n">filelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">fp</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
<span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c"># show the first few</span>
<span class="k">print</span> <span class="n">filelist</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="s">&#39;MCD15A2.A2005001.h17v03.005.2007350235547.hdf&#39;</span><span class="p">,</span> <span class="s">&#39;MCD15A2.A2005009.h17v03.005.2007351235445.hdf&#39;</span><span class="p">,</span> <span class="s">&#39;MCD15A2.A2005017.h17v03.005.2007352033411.hdf&#39;</span><span class="p">,</span> <span class="s">&#39;MCD15A2.A2005025.h17v03.005.2007353055037.hdf&#39;</span><span class="p">,</span> <span class="s">&#39;MCD15A2.A2005033.h17v03.005.2007355050158.hdf&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># an even neater way using np.loadtxt</span>
<span class="c"># But don&#39;t worry if you don&#39;t quite get this one yet!</span>

<span class="c"># define a function get_filename(f)</span>
<span class="c"># When a function is &#39;small&#39; its easier to use a lambda definition!</span>
<span class="n">get_filename</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">filelist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span><span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="n">get_filename</span><span class="p">})</span>

<span class="k">print</span> <span class="n">filelist</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="s">&#39;MCD15A2.A2005001.h17v03.005.2007350235547.hdf&#39;</span>
 <span class="s">&#39;MCD15A2.A2005009.h17v03.005.2007351235445.hdf&#39;</span>
 <span class="s">&#39;MCD15A2.A2005017.h17v03.005.2007352033411.hdf&#39;</span>
 <span class="s">&#39;MCD15A2.A2005025.h17v03.005.2007353055037.hdf&#39;</span>
 <span class="s">&#39;MCD15A2.A2005033.h17v03.005.2007355050158.hdf&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="read-just-the-data-we-want">
<h3>5.1.3 Read Just The Data We Want</h3>
<p>Last time, we generated a function to read MODIS LAI data.</p>
<p>We have now included such a function in the directory
<tt class="docutils literal"><span class="pre">`files/python</span></tt> &lt;files/python&gt;`__ called
<tt class="docutils literal"><span class="pre">`get_lai.py</span></tt> &lt;files/python/get_lai.py&gt;`__.</p>
<p>The only added sophistication is that when we call <tt class="docutils literal"><span class="pre">ReadAsArray</span></tt>, we
give it the starting cols, rows, and number of cols and rows to read
(e.g. <tt class="docutils literal"><span class="pre">xsize=600,yoff=300,xoff=300,ysize=600</span></tt>):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Now we have a list of filenames</span>
<span class="c"># load read_lai</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;files/python&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">get_lai</span> <span class="kn">import</span> <span class="n">get_lai</span>

<span class="n">help</span><span class="p">(</span><span class="n">get_lai</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>Help on function get_lai in module get_lai:

get_lai(filename, qc_layer=&#39;FparLai_QC&#39;, scale=[0.1, 0.1], mincol=0, minrow=0, ncol=None, nrow=None, selected_layers=[&#39;Lai_1km&#39;, &#39;LaiStdDev_1km&#39;])
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># e.g. for reading a single file:</span>

<span class="n">lai_file0</span> <span class="o">=</span> <span class="n">get_lai</span><span class="p">(</span><span class="s">&#39;files/data/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">filelist</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span><span class="n">ncol</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span><span class="n">mincol</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">minrow</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span><span class="n">nrow</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lai_file0</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.image.AxesImage at 0x10342b50&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_13_1.png" src="../_images/Interpolation_13_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">lai_file0</span><span class="p">)</span>
<span class="k">print</span> <span class="n">lai_file0</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;type &#39;dict&#39;&gt;
[&#39;Lai_1km&#39;, &#39;LaiStdDev_1km&#39;]
</pre></div>
</div>
<p>The function returns a dictionary with has keys
<tt class="docutils literal"><span class="pre">['Lai_1km',</span> <span class="pre">'LaiStdDev_1km',</span> <span class="pre">'FparLai_QC']</span></tt>:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="n">lai_file0</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
</pre></div>
</div>
<p>Each of these datasets is of shape <tt class="docutils literal"><span class="pre">(1200,</span> <span class="pre">1200)</span></tt>, but we have read
only 600 (columns) and 800 (rows) in this case. Note that the numpy
indexing is <tt class="docutils literal"><span class="pre">(rows,cols)</span></tt>.</p>
<p>We know how to create a mask from a vector dataset from thelast session:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">raster_mask</span> <span class="kn">import</span> <span class="n">raster_mask</span>

<span class="c"># make a raster mask</span>
<span class="c"># from the layer IRELAND in world.shp</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">file_template</span> <span class="o">=</span> <span class="s">&#39;HDF4_EOS:EOS_GRID:&quot;</span><span class="si">%s</span><span class="s">&quot;:MOD_Grid_MOD15A2:</span><span class="si">%s</span><span class="s">&#39;</span>
<span class="n">file_spec</span> <span class="o">=</span> <span class="n">file_template</span><span class="o">%</span><span class="p">(</span><span class="s">&#39;files/data/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">)</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">raster_mask</span><span class="p">(</span><span class="n">file_spec</span><span class="p">,</span>\
                   <span class="n">target_vector_file</span> <span class="o">=</span> <span class="s">&quot;files/data/world.shp&quot;</span><span class="p">,</span>\
                   <span class="n">attribute_filter</span> <span class="o">=</span> <span class="s">&quot;NAME = &#39;IRELAND&#39;&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x10ae5bd8&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_18_1.png" src="../_images/Interpolation_18_1.png" />
<p>In this case, the data we want is only a small section of the whole
spatial dataset.</p>
<p>It would be convenient to extract <em>only</em> the part we want.</p>
<p>We can use <tt class="docutils literal"><span class="pre">numpy.where()</span></tt> to help with this:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># The mask is False for the area we want</span>
<span class="n">rowpix</span><span class="p">,</span><span class="n">colpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span>

<span class="k">print</span> <span class="n">rowpix</span><span class="p">,</span><span class="n">colpix</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>[ 548  548  548 ..., 1024 1025 1025] [693 694 695 ..., 476 473 474]
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">rowpix</span></tt> and <tt class="docutils literal"><span class="pre">colpix</span></tt> are lists of pixel coordinates where the
condition we specified is <tt class="docutils literal"><span class="pre">True</span></tt> (i.e. where <tt class="docutils literal"><span class="pre">mask</span></tt> is <tt class="docutils literal"><span class="pre">False</span></tt>).</p>
<p>If we wanted to find the bounds of this area, we simply need to know the
minimum and maximum column and row in these lists:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">mincol</span><span class="p">,</span><span class="n">maxcol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">colpix</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">colpix</span><span class="p">)</span>
<span class="n">minrow</span><span class="p">,</span><span class="n">maxrow</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rowpix</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">rowpix</span><span class="p">)</span>

<span class="c"># think about why the + 1 here!!!</span>
<span class="c"># what if maxcol and mincol were the same?</span>
<span class="n">ncol</span> <span class="o">=</span> <span class="n">maxcol</span> <span class="o">-</span> <span class="n">mincol</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">nrow</span> <span class="o">=</span> <span class="n">maxrow</span> <span class="o">-</span> <span class="n">minrow</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">print</span> <span class="n">minrow</span><span class="p">,</span><span class="n">mincol</span><span class="p">,</span><span class="n">nrow</span><span class="p">,</span><span class="n">ncol</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>548 422 478 348
</pre></div>
</div>
<p>We could use this information to extract <em>only</em> the area we want when we
read the data:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">lai_file0</span> <span class="o">=</span> <span class="n">get_lai</span><span class="p">(</span><span class="s">&#39;files/data/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">filelist</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span>\
                    <span class="n">ncol</span><span class="o">=</span><span class="n">ncol</span><span class="p">,</span><span class="n">nrow</span><span class="o">=</span><span class="n">nrow</span><span class="p">,</span><span class="n">mincol</span><span class="o">=</span><span class="n">mincol</span><span class="p">,</span><span class="n">minrow</span><span class="o">=</span><span class="n">minrow</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lai_file0</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.image.AxesImage at 0x10ddc2d0&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_24_1.png" src="../_images/Interpolation_24_1.png" />
<p>Now, lets extract this portion of the mask:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">small_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">minrow</span><span class="p">:</span><span class="n">minrow</span><span class="o">+</span><span class="n">nrow</span><span class="p">,</span><span class="n">mincol</span><span class="p">:</span><span class="n">mincol</span><span class="o">+</span><span class="n">ncol</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">small_mask</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.image.AxesImage at 0x2ae9e41a3750&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_26_1.png" src="../_images/Interpolation_26_1.png" />
<p>And combine the country mask with the small dataset:</p>
<p>As a recap, we can use the function <tt class="docutils literal"><span class="pre">raster_mask</span></tt> that we gave you
last time to develop a raster mask (!) from an ESRI shapefile
(<tt class="docutils literal"><span class="pre">files/data/world.shp</span></tt> here).</p>
<p>We can then combine this mask with the QC-derived mask in the LAI
dataset.</p>
<p>The LAI mask (that will be <tt class="docutils literal"><span class="pre">lai.mask</span></tt> in the code below) is <tt class="docutils literal"><span class="pre">False</span></tt>
for good data, as is the coutry mask.</p>
<p>To combine them, we want some operator <tt class="docutils literal"><span class="pre">X</span></tt> for which:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">True</span>&nbsp; <span class="pre">X</span> <span class="pre">True</span>&nbsp; <span class="pre">==</span> <span class="pre">True</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">True</span>&nbsp; <span class="pre">X</span> <span class="pre">False</span> <span class="pre">==</span> <span class="pre">True</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">False</span> <span class="pre">X</span> <span class="pre">True</span>&nbsp; <span class="pre">==</span> <span class="pre">True</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">False</span> <span class="pre">X</span> <span class="pre">False</span> <span class="pre">==</span> <span class="pre">False</span></tt></div>
</div>
<p>The operator to use then is an <em>or</em>, here, a bitwise or, <tt class="docutils literal"><span class="pre">|</span></tt>.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">lai_file0</span> <span class="o">=</span> <span class="n">get_lai</span><span class="p">(</span><span class="s">&#39;files/data/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">filelist</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span>\
                    <span class="n">ncol</span><span class="o">=</span><span class="n">ncol</span><span class="p">,</span><span class="n">nrow</span><span class="o">=</span><span class="n">nrow</span><span class="p">,</span><span class="n">mincol</span><span class="o">=</span><span class="n">mincol</span><span class="p">,</span><span class="n">minrow</span><span class="o">=</span><span class="n">minrow</span><span class="p">)</span>

<span class="n">layer</span> <span class="o">=</span> <span class="s">&#39;Lai_1km&#39;</span>
<span class="n">lai</span> <span class="o">=</span> <span class="n">lai_file0</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
<span class="n">small_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">minrow</span><span class="p">:</span><span class="n">minrow</span><span class="o">+</span><span class="n">nrow</span><span class="p">,</span><span class="n">mincol</span><span class="p">:</span><span class="n">mincol</span><span class="o">+</span><span class="n">ncol</span><span class="p">]</span>

<span class="c"># combined mask</span>
<span class="n">new_mask</span> <span class="o">=</span> <span class="n">small_mask</span> <span class="o">|</span> <span class="n">lai</span><span class="o">.</span><span class="n">mask</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">new_mask</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>

<span class="n">lai</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lai</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lai</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.image.AxesImage at 0x2ae9e4275f50&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_29_1.png" src="../_images/Interpolation_29_1.png" />
<img alt="../_images/Interpolation_29_2.png" src="../_images/Interpolation_29_2.png" />
<p>We should be used to writing loops around such functions.</p>
<p>In this case, we read <em>all</em> of the files in <tt class="docutils literal"><span class="pre">filelist</span></tt> and put the
data into the dictionary called <tt class="docutils literal"><span class="pre">lai</span></tt> here.</p>
<p>Because there are multiple layers in the datasets, we loop over layer
and append to each list indiviually:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># load &#39;em all ...</span>

<span class="c"># for United Kingdom here</span>

<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>
<span class="kn">from</span> <span class="nn">raster_mask</span> <span class="kn">import</span> <span class="n">raster_mask</span>

<span class="n">country</span> <span class="o">=</span> <span class="s">&#39;UNITED KINGDOM&#39;</span>

<span class="c"># make a raster mask</span>
<span class="c"># from the layer UNITED KINGDOM in world.shp</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">file_template</span> <span class="o">=</span> <span class="s">&#39;HDF4_EOS:EOS_GRID:&quot;</span><span class="si">%s</span><span class="s">&quot;:MOD_Grid_MOD15A2:</span><span class="si">%s</span><span class="s">&#39;</span>
<span class="n">file_spec</span> <span class="o">=</span> <span class="n">file_template</span><span class="o">%</span><span class="p">(</span><span class="s">&#39;files/data/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">)</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">raster_mask</span><span class="p">(</span><span class="n">file_spec</span><span class="p">,</span>\
                   <span class="n">target_vector_file</span> <span class="o">=</span> <span class="s">&quot;files/data/world.shp&quot;</span><span class="p">,</span>\
                   <span class="n">attribute_filter</span> <span class="o">=</span> <span class="s">&quot;NAME = &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">country</span><span class="p">)</span>
<span class="c"># extract just the area we want</span>
<span class="c"># by getting the min/max rows/cols</span>
<span class="c"># of the data mask</span>
<span class="c"># The mask is False for the area we want</span>
<span class="n">rowpix</span><span class="p">,</span><span class="n">colpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">mincol</span><span class="p">,</span><span class="n">maxcol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">colpix</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">colpix</span><span class="p">)</span>
<span class="n">minrow</span><span class="p">,</span><span class="n">maxrow</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rowpix</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">rowpix</span><span class="p">)</span>
<span class="n">ncol</span> <span class="o">=</span> <span class="n">maxcol</span> <span class="o">-</span> <span class="n">mincol</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">nrow</span> <span class="o">=</span> <span class="n">maxrow</span> <span class="o">-</span> <span class="n">minrow</span> <span class="o">+</span> <span class="mi">1</span>
<span class="c"># and make a small mask</span>
<span class="n">small_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">minrow</span><span class="p">:</span><span class="n">minrow</span><span class="o">+</span><span class="n">nrow</span><span class="p">,</span><span class="n">mincol</span><span class="p">:</span><span class="n">mincol</span><span class="o">+</span><span class="n">ncol</span><span class="p">]</span>


<span class="c"># data_fields with empty lists</span>
<span class="n">data_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;LaiStdDev_1km&#39;</span><span class="p">:[],</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">:[]}</span>

<span class="c"># make a dictionary and put the filenames in it</span>
<span class="c"># along with the mask and min/max info</span>
<span class="n">lai</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;filenames&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">filelist</span><span class="p">),</span>\
       <span class="s">&#39;minrow&#39;</span><span class="p">:</span><span class="n">minrow</span><span class="p">,</span><span class="s">&#39;mincol&#39;</span><span class="p">:</span><span class="n">mincol</span><span class="p">,</span>\
       <span class="s">&#39;mask&#39;</span><span class="p">:</span><span class="n">small_mask</span><span class="p">}</span>

<span class="c"># combine the dictionaries</span>
<span class="n">lai</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data_fields</span><span class="p">)</span>

<span class="c"># loop over each filename</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="s">&#39;filenames&#39;</span><span class="p">]):</span>
    <span class="n">this_lai</span> <span class="o">=</span> <span class="n">get_lai</span><span class="p">(</span><span class="s">&#39;files/data/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">f</span><span class="p">,</span>\
                       <span class="n">mincol</span><span class="o">=</span><span class="n">mincol</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="n">ncol</span><span class="p">,</span>\
                       <span class="n">minrow</span><span class="o">=</span><span class="n">minrow</span><span class="p">,</span><span class="n">nrow</span><span class="o">=</span><span class="n">nrow</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">data_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c"># apply the mask</span>
        <span class="n">new_mask</span> <span class="o">=</span> <span class="n">this_lai</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">|</span> <span class="n">small_mask</span>
        <span class="n">this_lai</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">this_lai</span><span class="p">[</span><span class="n">layer</span><span class="p">],</span><span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span><span class="p">)</span>
        <span class="n">lai</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_lai</span><span class="p">[</span><span class="n">layer</span><span class="p">])</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># have a look at one of these</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">20</span>

<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="c"># just see what the shape is ...</span>
<span class="k">print</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="n">root</span> <span class="o">=</span> <span class="s">&#39;files/images/lai_uk&#39;</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greens</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;filenames&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="c"># get some info from filename</span>
<span class="n">file_id</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">print</span> <span class="n">file_id</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="c"># plot a jpg</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;files/images/lai_uk_</span><span class="si">%s</span><span class="s">.jpg&#39;</span><span class="o">%</span><span class="n">file_id</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">566</span><span class="p">)</span>
<span class="mi">2005161</span>
</pre></div>
</div>
<img alt="../_images/Interpolation_32_1.png" src="../_images/Interpolation_32_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># thats quite good, so put as a function:</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;files/python&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">get_lai</span> <span class="kn">import</span> <span class="n">get_lai</span>
<span class="kn">from</span> <span class="nn">raster_mask</span> <span class="kn">import</span> <span class="n">raster_mask</span>


<span class="k">def</span> <span class="nf">read_lai</span><span class="p">(</span><span class="n">filelist</span><span class="p">,</span><span class="n">datadir</span><span class="o">=</span><span class="s">&#39;files/data&#39;</span><span class="p">,</span><span class="n">country</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read MODIS LAI data from a set of files</span>
<span class="sd">    in the list filelist. Data assumed to be in</span>
<span class="sd">    directory datadir.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    filelist : list of LAI files</span>

<span class="sd">    Options:</span>
<span class="sd">    datadir  : data directory</span>
<span class="sd">    country  : country name (in files/data/world.shp)</span>

<span class="sd">    Returns:</span>
<span class="sd">    lai dictionary</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">country</span><span class="p">:</span>
        <span class="c"># make a raster mask</span>
        <span class="c"># from the layer UNITED KINGDOM in world.shp</span>
        <span class="n">file_template</span> <span class="o">=</span> <span class="s">&#39;HDF4_EOS:EOS_GRID:&quot;</span><span class="si">%s</span><span class="s">&quot;:MOD_Grid_MOD15A2:</span><span class="si">%s</span><span class="s">&#39;</span>
        <span class="n">file_spec</span> <span class="o">=</span> <span class="n">file_template</span><span class="o">%</span><span class="p">(</span><span class="s">&#39;files/data/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">raster_mask</span><span class="p">(</span><span class="n">file_spec</span><span class="p">,</span>\
                           <span class="n">target_vector_file</span> <span class="o">=</span> <span class="s">&quot;files/data/world.shp&quot;</span><span class="p">,</span>\
                           <span class="n">attribute_filter</span> <span class="o">=</span> <span class="s">&quot;NAME = &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">country</span><span class="p">)</span>
        <span class="c"># extract just the area we want</span>
        <span class="c"># by getting the min/max rows/cols</span>
        <span class="c"># of the data mask</span>
        <span class="c"># The mask is False for the area we want</span>
        <span class="n">rowpix</span><span class="p">,</span><span class="n">colpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">mincol</span><span class="p">,</span><span class="n">maxcol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">colpix</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">colpix</span><span class="p">)</span>
        <span class="n">minrow</span><span class="p">,</span><span class="n">maxrow</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rowpix</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">rowpix</span><span class="p">)</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="n">maxcol</span> <span class="o">-</span> <span class="n">mincol</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="n">maxrow</span> <span class="o">-</span> <span class="n">minrow</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c"># and make a small mask</span>
        <span class="n">small_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">minrow</span><span class="p">:</span><span class="n">minrow</span><span class="o">+</span><span class="n">nrow</span><span class="p">,</span><span class="n">mincol</span><span class="p">:</span><span class="n">mincol</span><span class="o">+</span><span class="n">ncol</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># no country</span>
        <span class="n">mincol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maxcol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># data_fields with empty lists</span>
    <span class="n">data_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;LaiStdDev_1km&#39;</span><span class="p">:[],</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">:[]}</span>

    <span class="c"># make a dictionary and put the filenames in it</span>
    <span class="c"># along with the mask and min/max info</span>
    <span class="n">lai</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;filenames&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">filelist</span><span class="p">),</span>\
           <span class="s">&#39;minrow&#39;</span><span class="p">:</span><span class="n">minrow</span><span class="p">,</span><span class="s">&#39;mincol&#39;</span><span class="p">:</span><span class="n">mincol</span><span class="p">,</span>\
           <span class="s">&#39;mask&#39;</span><span class="p">:</span><span class="n">small_mask</span><span class="p">}</span>

    <span class="c"># combine the dictionaries</span>
    <span class="n">lai</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data_fields</span><span class="p">)</span>

    <span class="c"># loop over each filename</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="s">&#39;filenames&#39;</span><span class="p">]):</span>
        <span class="n">this_lai</span> <span class="o">=</span> <span class="n">get_lai</span><span class="p">(</span><span class="s">&#39;files/data/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">f</span><span class="p">,</span>\
                           <span class="n">mincol</span><span class="o">=</span><span class="n">mincol</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="n">ncol</span><span class="p">,</span>\
                           <span class="n">minrow</span><span class="o">=</span><span class="n">minrow</span><span class="p">,</span><span class="n">nrow</span><span class="o">=</span><span class="n">nrow</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">data_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c"># apply the mask</span>
            <span class="k">if</span> <span class="n">country</span><span class="p">:</span>
                <span class="n">new_mask</span> <span class="o">=</span> <span class="n">this_lai</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">|</span> <span class="n">small_mask</span>
                <span class="n">this_lai</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">this_lai</span><span class="p">[</span><span class="n">layer</span><span class="p">],</span><span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span><span class="p">)</span>
            <span class="n">lai</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_lai</span><span class="p">[</span><span class="n">layer</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">data_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">lai</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="n">layer</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">lai</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># test this ... the one in the file</span>
<span class="c"># does a cutout of the data area as well</span>
<span class="c"># which will keep the memory</span>
<span class="c"># requirements down</span>
<span class="kn">from</span> <span class="nn">get_lai</span> <span class="kn">import</span> <span class="n">read_lai</span>

<span class="n">lai</span> <span class="o">=</span> <span class="n">read_lai</span><span class="p">(</span><span class="n">filelist</span><span class="p">,</span><span class="n">country</span><span class="o">=</span><span class="s">&#39;IRELAND&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># have a look at one of these</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c"># just see what the shape is ...</span>
<span class="k">print</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="n">root</span> <span class="o">=</span> <span class="s">&#39;files/images/lai_eire&#39;</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greens</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;filenames&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="c"># get some info from filename</span>
<span class="n">file_id</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">print</span> <span class="n">file_id</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="c"># plot a jpg</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">.jpg&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">file_id</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>creating mask of IRELAND
... MCD15A2.A2005001.h17v03.005.2007350235547.hdf
... MCD15A2.A2005009.h17v03.005.2007351235445.hdf
... MCD15A2.A2005017.h17v03.005.2007352033411.hdf
... MCD15A2.A2005025.h17v03.005.2007353055037.hdf
... MCD15A2.A2005033.h17v03.005.2007355050158.hdf
... MCD15A2.A2005041.h17v03.005.2007357014602.hdf
... MCD15A2.A2005049.h17v03.005.2007360165724.hdf
... MCD15A2.A2005057.h17v03.005.2007361230641.hdf
... MCD15A2.A2005065.h17v03.005.2007365024202.hdf
... MCD15A2.A2005073.h17v03.005.2008001043631.hdf
... MCD15A2.A2005081.h17v03.005.2008003173048.hdf
... MCD15A2.A2005089.h17v03.005.2008005154542.hdf
... MCD15A2.A2005097.h17v03.005.2008007175837.hdf
... MCD15A2.A2005105.h17v03.005.2008018085544.hdf
... MCD15A2.A2005113.h17v03.005.2008021020137.hdf
... MCD15A2.A2005121.h17v03.005.2008021193749.hdf
... MCD15A2.A2005129.h17v03.005.2008024061330.hdf
... MCD15A2.A2005137.h17v03.005.2008032075236.hdf
... MCD15A2.A2005145.h17v03.005.2008033192556.hdf
... MCD15A2.A2005153.h17v03.005.2008035054421.hdf
... MCD15A2.A2005161.h17v03.005.2008036173810.hdf
... MCD15A2.A2005169.h17v03.005.2008039132812.hdf
... MCD15A2.A2005177.h17v03.005.2008042090537.hdf
... MCD15A2.A2005185.h17v03.005.2008044115459.hdf
... MCD15A2.A2005193.h17v03.005.2008046140018.hdf
... MCD15A2.A2005201.h17v03.005.2008050015227.hdf
... MCD15A2.A2005209.h17v03.005.2008052203557.hdf
... MCD15A2.A2005217.h17v03.005.2008055145215.hdf
... MCD15A2.A2005225.h17v03.005.2008057010213.hdf
... MCD15A2.A2005233.h17v03.005.2008060214119.hdf
... MCD15A2.A2005241.h17v03.005.2008063115631.hdf
... MCD15A2.A2005249.h17v03.005.1998144165707.hdf
... MCD15A2.A2005257.h17v03.005.2008067051936.hdf
... MCD15A2.A2005265.h17v03.005.2008069073121.hdf
... MCD15A2.A2005273.h17v03.005.2008071050025.hdf
... MCD15A2.A2005281.h17v03.005.2008072202421.hdf
... MCD15A2.A2005289.h17v03.005.2008074194126.hdf
... MCD15A2.A2005297.h17v03.005.2008077061121.hdf
... MCD15A2.A2005305.h17v03.005.2008080055607.hdf
... MCD15A2.A2005313.h17v03.005.2008083165435.hdf
... MCD15A2.A2005321.h17v03.005.2008084043211.hdf
... MCD15A2.A2005329.h17v03.005.2008086063619.hdf
... MCD15A2.A2005337.h17v03.005.2008087175845.hdf
... MCD15A2.A2005345.h17v03.005.2008088144615.hdf
... MCD15A2.A2005353.h17v03.005.2008091004441.hdf
... MCD15A2.A2005361.h17v03.005.2008091025114.hdf
... done
(478, 348)
2005161
</pre></div>
</div>
<img alt="../_images/Interpolation_34_1.png" src="../_images/Interpolation_34_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># make a movie</span>

<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c"># just see what the shape is ...</span>
<span class="k">print</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="n">root</span> <span class="o">=</span> <span class="s">&#39;files/images/lai_country_eire&#39;</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greens</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="s">&#39;filenames&#39;</span><span class="p">]):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="c"># get some info from filename</span>
    <span class="n">file_id</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">print</span> <span class="n">file_id</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="c"># plot a jpg</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">.jpg&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">file_id</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;convert -delay 100 -loop 0 {0}_*.jpg {0}_movie.gif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="mi">478</span><span class="p">,</span> <span class="mi">348</span><span class="p">)</span>
<span class="mi">2005001</span>
<span class="mi">2005009</span>
<span class="mi">2005017</span>
<span class="mi">2005025</span>
<span class="mi">2005033</span>
<span class="mi">2005041</span>
<span class="mi">2005049</span>
<span class="mi">2005057</span>
<span class="mi">2005065</span>
<span class="mi">2005073</span>
<span class="mi">2005081</span>
<span class="mi">2005089</span>
<span class="mi">2005097</span>
<span class="mi">2005105</span>
<span class="mi">2005113</span>
<span class="mi">2005121</span>
<span class="mi">2005129</span>
<span class="mi">2005137</span>
<span class="mi">2005145</span>
<span class="mi">2005153</span>
<span class="mi">2005161</span>
<span class="mi">2005169</span>
<span class="mi">2005177</span>
<span class="mi">2005185</span>
<span class="mi">2005193</span>
<span class="mi">2005201</span>
<span class="mi">2005209</span>
<span class="mi">2005217</span>
<span class="mi">2005225</span>
<span class="mi">2005233</span>
<span class="mi">2005241</span>
<span class="mi">2005249</span>
<span class="mi">2005257</span>
<span class="mi">2005265</span>
<span class="mi">2005273</span>
<span class="mi">2005281</span>
<span class="mi">2005289</span>
<span class="mi">2005297</span>
<span class="mi">2005305</span>
<span class="mi">2005313</span>
<span class="mi">2005321</span>
<span class="mi">2005329</span>
<span class="mi">2005337</span>
<span class="mi">2005345</span>
<span class="mi">2005353</span>
<span class="mi">2005361</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">0</span>
</pre></div>
</div>
<div class="figure">
<img alt="" src="Chapter5_Interpolation/files/images/lai_country_eire_movie.gif" />
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># The movie making works, so pack that into a function</span>

<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">root</span> <span class="o">=</span> <span class="s">&#39;files/images/lai_eire&#39;</span>

<span class="k">def</span> <span class="nf">make_movie</span><span class="p">(</span><span class="n">lai</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">layer</span><span class="o">=</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">do_plot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Make an animated gif from MODIS LAI data in</span>
<span class="sd">    dictionary &#39;lai&#39;.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    lai    : data dictionary</span>
<span class="sd">    root   : root file /directory name of frames and movie</span>

<span class="sd">    layer  : data layer to plot</span>
<span class="sd">    vmax   : max value for plotting</span>
<span class="sd">    vmin   : min value for plotting</span>
<span class="sd">    do_plot: set True if you want the individual plots</span>
<span class="sd">             to display</span>

<span class="sd">    Returns:</span>
<span class="sd">    movie name</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greens</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="s">&#39;filenames&#39;</span><span class="p">]):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
        <span class="c"># get some info from filename</span>
        <span class="n">file_id</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">print</span> <span class="n">file_id</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span>\
                   <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">)</span>
        <span class="c"># plot a jpg</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">.jpg&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">file_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;convert -delay 100 -loop 0 {0}_*.jpg {0}_movie.gif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;{0}_movie.gif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># test it</span>

<span class="n">lai_uk</span> <span class="o">=</span> <span class="n">read_lai</span><span class="p">(</span><span class="n">filelist</span><span class="p">,</span><span class="n">country</span><span class="o">=</span><span class="s">&#39;UNITED KINGDOM&#39;</span><span class="p">)</span>
<span class="n">root</span> <span class="o">=</span> <span class="s">&#39;files/images/lai_UK&#39;</span>
<span class="n">movie</span> <span class="o">=</span> <span class="n">make_movie</span><span class="p">(</span><span class="n">lai_uk</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
<span class="k">print</span> <span class="n">movie</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">2005001</span>
<span class="mi">2005009</span>
<span class="mi">2005017</span>
<span class="mi">2005025</span>
<span class="mi">2005033</span>
<span class="mi">2005041</span>
<span class="mi">2005049</span>
<span class="mi">2005057</span>
<span class="mi">2005065</span>
<span class="mi">2005073</span>
<span class="mi">2005081</span>
<span class="mi">2005089</span>
<span class="mi">2005097</span>
<span class="mi">2005105</span>
<span class="mi">2005113</span>
<span class="mi">2005121</span>
<span class="mi">2005129</span>
<span class="mi">2005137</span>
<span class="mi">2005145</span>
<span class="mi">2005153</span>
<span class="mi">2005161</span>
<span class="mi">2005169</span>
<span class="mi">2005177</span>
<span class="mi">2005185</span>
<span class="mi">2005193</span>
<span class="mi">2005201</span>
<span class="mi">2005209</span>
<span class="mi">2005217</span>
<span class="mi">2005225</span>
<span class="mi">2005233</span>
<span class="mi">2005241</span>
<span class="mi">2005249</span>
<span class="mi">2005257</span>
<span class="mi">2005265</span>
<span class="mi">2005273</span>
<span class="mi">2005281</span>
<span class="mi">2005289</span>
<span class="mi">2005297</span>
<span class="mi">2005305</span>
<span class="mi">2005313</span>
<span class="mi">2005321</span>
<span class="mi">2005329</span>
<span class="mi">2005337</span>
<span class="mi">2005345</span>
<span class="mi">2005353</span>
<span class="mi">2005361</span>
<span class="n">files</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">lai_UK_movie</span><span class="o">.</span><span class="n">gif</span>
</pre></div>
</div>
<div class="figure">
<img alt="" src="Chapter5_Interpolation/files/images/lai_UK_movie.gif" />
</div>
</div>
</div>
<div class="section" id="interpolation">
<h2>5.2 Interpolation</h2>
<div class="section" id="univariate-interpolation">
<h3>5.2.1 Univariate interpolation</h3>
<p>So, we can load the data we want from multiple MODIS hdf files that we
have downloaded from the NASA server into a 3D masked numpy array, with
a country boundary mask (projected int the raster data coordinate
system) from a vector dataset.</p>
<p>Let&#8217;s start to explore the data then.</p>
<p>You should have an array of LAI for Ireland:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="nb">type</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span>
</pre></div>
</div>
<p>Let&#8217;s plot the LAI for some given pixels.</p>
<p>First, we might like to identify which pixels actually have any data.</p>
<p>A convenient function for this would be <tt class="docutils literal"><span class="pre">np.where</span></tt> that returns the
indices of items that are <tt class="docutils literal"><span class="pre">True</span></tt>.</p>
<p>Since the data mask is <tt class="docutils literal"><span class="pre">False</span></tt> for good data, we take the complement
<tt class="docutils literal"><span class="pre">~</span></tt> so that good data are `True:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">]</span>
<span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">array</span><span class="p">([</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">]),</span>
 <span class="n">array</span><span class="p">([</span><span class="mi">326</span><span class="p">,</span> <span class="mi">328</span><span class="p">,</span> <span class="mi">329</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mi">472</span><span class="p">,</span> <span class="mi">472</span><span class="p">,</span> <span class="mi">475</span><span class="p">]),</span>
 <span class="n">array</span><span class="p">([</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span>  <span class="mi">83</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mi">86</span><span class="p">,</span>  <span class="mi">87</span><span class="p">,</span>  <span class="mi">51</span><span class="p">]))</span>
</pre></div>
</div>
<p>An example good pixel this is (3,329,145). Let&#8217;s look at this for all
time periods:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">]</span>

<span class="n">r</span> <span class="o">=</span> <span class="mi">329</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">83</span>

<span class="n">pixel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>

<span class="c"># plot red stars at the data points</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixel</span><span class="p">))</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="s">&#39;r*&#39;</span><span class="p">)</span>
<span class="c"># plot a black (k) dashed line (--)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixel</span><span class="p">))</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="s">&#39;k--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;doy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;LAI&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;pixel </span><span class="si">%03d</span><span class="s"> </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.text.Text at 0x11e77950&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_47_1.png" src="../_images/Interpolation_47_1.png" />
<p>The data follow the trend of what we might expect for LAI development,
but they are clearly a little noisy.</p>
<p>We also have access to uncertainty information (standard deviation):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># copy the data in case we change it any</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">sd</span>   <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;LaiStdDev_1km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="mi">329</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">83</span>

<span class="n">pixel</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
<span class="n">pixel_sd</span> <span class="o">=</span>   <span class="n">sd</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixel</span><span class="p">))</span><span class="o">*</span><span class="mi">8</span>

<span class="c"># plot red stars at the data points</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="s">&#39;r*&#39;</span><span class="p">)</span>
<span class="c"># plot a black (k) dashed line (--)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="s">&#39;k--&#39;</span><span class="p">)</span>
<span class="c"># plot error bars:</span>
<span class="c"># 1.96 because that is the 95% confidence interval</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">pixel_sd</span><span class="o">*</span><span class="mf">1.96</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;doy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;LAI&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;pixel </span><span class="si">%03d</span><span class="s"> </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.text.Text at 0x2ae9e53409d0&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_49_1.png" src="../_images/Interpolation_49_1.png" />
<p>We would generally expect LAI to be quite smoothly varying over time.
Visualising the data with 95% confidence intervals is quite useful as we
can now &#8216;imagine&#8217; some smooth line that would generally go within these
bounds.</p>
<p>Some of the uncertainty estimates are really rather small though, which
are probably not reliable.</p>
<p>Let&#8217;s inflate them:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">sd</span>   <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;LaiStdDev_1km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="mi">329</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">83</span>

<span class="n">pixel</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
<span class="n">pixel_sd</span> <span class="o">=</span>   <span class="n">sd</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
<span class="c"># threshold</span>
<span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">pixel_sd</span><span class="p">[</span><span class="n">pixel_sd</span><span class="o">&lt;</span><span class="n">thresh</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixel</span><span class="p">))</span><span class="o">*</span><span class="mi">8</span>

<span class="c"># plot red stars at the data points</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="s">&#39;r*&#39;</span><span class="p">)</span>
<span class="c"># plot a black (k) dashed line (--)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="s">&#39;k--&#39;</span><span class="p">)</span>
<span class="c"># plot error bars:</span>
<span class="c"># 1.96 because that is the 95% confidence interval</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">pixel_sd</span><span class="o">*</span><span class="mf">1.96</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;doy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;LAI&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;pixel </span><span class="si">%03d</span><span class="s"> </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.text.Text at 0x2ae9e5554910&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_51_1.png" src="../_images/Interpolation_51_1.png" />
<p>This is perhaps a bit more realistic ...</p>
<p>The data now have some missing values (data gaps) and, as we have noted,
are a little noisy.</p>
<p>A Python module we can use for many scientific functions is
<tt class="docutils literal"><span class="pre">`scipy</span></tt> &lt;<a class="reference external" href="http://docs.scipy.org/doc/scipy">http://docs.scipy.org/doc/scipy</a>&gt;`__, in particular here, the
<tt class="docutils literal"><span class="pre">`scipy</span></tt> interpolation
functions &lt;<a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/interpolate.html">http://docs.scipy.org/doc/scipy/reference/interpolate.html</a>&gt;`__.</p>
<p>We need to make a careful choice of the interpolation functions.</p>
<p>We might, in many circumstances simply want something that interpolates
between data points, i.e. that goes through the data points that we
have.</p>
<p>Many interpolators will not provide extrapolation, so in the example
above we could not get an estimate of LAI prior to the first sample and
after the last.</p>
<p>The best way to deal with that would be to have multiple years of data.</p>
<p>Instead here, we will repeat the dataset three times to mimic this:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>

<span class="n">pixel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>

<span class="c"># original x,y</span>
<span class="n">y_</span> <span class="o">=</span> <span class="n">pixel</span>
<span class="n">x_</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_</span><span class="p">))</span><span class="o">*</span><span class="mf">8.</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="o">~</span><span class="n">pixel</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
<span class="n">y_</span> <span class="o">=</span> <span class="n">y_</span><span class="p">[</span><span class="o">~</span><span class="n">pixel</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>

<span class="c"># extend: using np.tile() to repeat data</span>
<span class="n">y_extend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">y_</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="c"># extend: using vstack to stack 3 different arrays</span>
<span class="n">x_extend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x_</span><span class="o">-</span><span class="mi">46</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="n">x_</span><span class="p">,</span><span class="n">x_</span><span class="o">+</span><span class="mi">46</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># plot the extended dataset</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_extend</span><span class="p">,</span><span class="n">y_extend</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">,</span><span class="s">&#39;k+&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">],[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.5</span><span class="p">],</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">365.</span><span class="p">,</span><span class="mf">365.</span><span class="p">],[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.5</span><span class="p">],</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">356</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;day of year&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;LAI&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.text.Text at 0x2ae9e6108550&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_54_1.png" src="../_images/Interpolation_54_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># define xnew at 1 day interval</span>
<span class="n">xnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mf">366.</span><span class="p">)</span>

<span class="c"># linear interpolation</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x_extend</span><span class="p">,</span><span class="n">y_extend</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">)</span>
<span class="n">ynew</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">xnew</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span><span class="n">ynew</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">,</span><span class="s">&#39;r+&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/Interpolation_56_1.png" src="../_images/Interpolation_56_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># cubic interpolation</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x_extend</span><span class="p">,</span><span class="n">y_extend</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;cubic&#39;</span><span class="p">)</span>
<span class="n">ynew</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">xnew</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span><span class="n">ynew</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">,</span><span class="s">&#39;r+&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/Interpolation_57_1.png" src="../_images/Interpolation_57_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># nearest neighbour interpolation</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x_extend</span><span class="p">,</span><span class="n">y_extend</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">ynew</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">xnew</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span><span class="n">ynew</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">,</span><span class="s">&#39;r+&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/Interpolation_58_1.png" src="../_images/Interpolation_58_1.png" />
<p>Depending on the problem you are trying to solve, different
interpolation schemes will be appropriate. For categorical data (e.g.
&#8216;snow&#8217;, coded as 1 and &#8216;no snow&#8217; coded as 1), for instance, a nearest
neighbour interpolation might be a good idea.</p>
</div>
<div class="section" id="smoothing">
<h3>5.2.2 Smoothing</h3>
<p>One issue with the schemes above is that they go exactly through the
data points, but a more realistic description of the data might be one
that incorporated the uncertainty information we have. Visually, this is
quite easy to imagine, but how can we implement such ideas?</p>
<p>One way of thinking about this is to think about other sources of
information that we might bring to bear on the problem. One such would
be that we expect the function to be &#8216;quite smooth&#8217;. This allows us to
consider applying smoothness as an additional constraint to the
solution.</p>
<p>Many such problems can be phrased as convolution operations.</p>
<p>Convolution is a form of digital filtering that combines two sequences
of numbers <span class="math">\(y\)</span> and <span class="math">\(w\)</span> to give a third, the result <span class="math">\(z\)</span>
that is a filtered version of <span class="math">\(y\)</span>, where for each element
<span class="math">\(j\)</span> of <span class="math">\(y\)</span>:</p>
<div class="math">
\[z_j = \sum_{i=-n}^{i=n}{w_i y_{j+i}}\]</div>
<p>where <span class="math">\(n\)</span> is the half width of the filter <span class="math">\(w\)</span>. For a
smoothing filter, the elements of this will sum to 1 (so that the
magnitude of <span class="math">\(y\)</span> is not changed).</p>
<p>To illustrate this in Python:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># a simple box smoothing filter</span>
<span class="c"># filter width 11</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="c"># normalise</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="c"># half width</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="c"># Take the linear interpolation of the LAI above as the signal</span>
<span class="c"># linear interpolation</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xnew</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x_extend</span><span class="p">,</span><span class="n">y_extend</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c"># where we will put the result</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c"># This is a straight implementation of the</span>
<span class="c"># equation above</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;k--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;z&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;smoothing with filter width </span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.text.Text at 0x2ae9e579e3d0&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_63_1.png" src="../_images/Interpolation_63_1.png" />
<p>As we suggested, the result of convolving <span class="math">\(y\)</span> with the filter
<span class="math">\(w\)</span> (of width 31 here) is <span class="math">\(z\)</span>, a smoothed version of
<span class="math">\(y\)</span>.</p>
<p>You might notice that the filter is only applied once we are <tt class="docutils literal"><span class="pre">n</span></tt>
samples into the signal, so we get &#8216;edge effects&#8217;. There are various
ways of dealing with edge effects, such as repeating the signal (as we
did above, for much the same reason), reflecting the signal, or assuming
the signal to be some constant value (e.g. 0) outside of its defined
domain.</p>
<p>If we make the filter wider (width 31 now):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># a simple box smoothing filter</span>
<span class="c"># filter width 31</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span>
<span class="c"># normalise</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="c"># half width</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="c"># Take the linear interpolation of the LAI above as the signal</span>
<span class="c"># linear interpolation</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xnew</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x_extend</span><span class="p">,</span><span class="n">y_extend</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c"># where we will put the result</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c"># This is a straight implementation of the</span>
<span class="c"># equation above</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;k--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;z&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;smoothing with filter width </span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.text.Text at 0x2ae9e61f8cd0&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_65_1.png" src="../_images/Interpolation_65_1.png" />
<p>Then the signal is &#8216;more&#8217; smoothed.</p>
<p>There are <em>many</em> filters implemented in
<tt class="docutils literal"><span class="pre">`scipy.signal</span></tt> &lt;<a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/signal.html">http://docs.scipy.org/doc/scipy/reference/signal.html</a>&gt;`__
that you should look over.</p>
<p>A very commonly used smoothing filter is the
<a class="reference external" href="http://en.wikipedia.org/wiki/Savitzky–Golay_filter_for_smoothing_and_differentiation">Savitsky-Golay</a><span class="link-target"> [http://en.wikipedia.org/wiki/Savitzky–Golay_filter_for_smoothing_and_differentiation]</span>
filter for which you define the window size and filter order.</p>
<p>As with most filters, the filter width controls the degree of smoothing
(see examples above). The filter order (related to polynomial order) in
essence controls the shape of the filter and defines the &#8216;peakiness&#8217; of
the response.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;files/python&#39;</span><span class="p">)</span>
<span class="c"># see http://wiki.scipy.org/Cookbook/SavitzkyGolay</span>
<span class="kn">from</span> <span class="nn">savitzky_golay</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">window_size</span> <span class="o">=</span> <span class="mi">31</span>
<span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c"># Take the linear interpolation of the LAI above as the signal</span>
<span class="c"># linear interpolation</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xnew</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x_extend</span><span class="p">,</span><span class="n">y_extend</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">z</span> <span class="o">=</span> <span class="n">savitzky_golay</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">window_size</span><span class="p">,</span><span class="n">order</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;k--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;z&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;smoothing with filter width </span><span class="si">%d</span><span class="s"> order </span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span><span class="n">order</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.text.Text at 0x2ae9e65e6890&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_68_1.png" src="../_images/Interpolation_68_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;files/python&#39;</span><span class="p">)</span>
<span class="c"># see http://wiki.scipy.org/Cookbook/SavitzkyGolay</span>
<span class="kn">from</span> <span class="nn">savitzky_golay</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">window_size</span> <span class="o">=</span> <span class="mi">61</span>
<span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c"># Take the linear interpolation of the LAI above as the signal</span>
<span class="c"># linear interpolation</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">xnew</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x_extend</span><span class="p">,</span><span class="n">y_extend</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">z</span> <span class="o">=</span> <span class="n">savitzky_golay</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">window_size</span><span class="p">,</span><span class="n">order</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;k--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;z&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;smoothing with filter width </span><span class="si">%d</span><span class="s"> order </span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span><span class="n">order</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.text.Text at 0x2ae9e663bb50&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_69_1.png" src="../_images/Interpolation_69_1.png" />
<p>If the samples <span class="math">\(y\)</span> have uncertainty (standard deviation
<span class="math">\(\sigma_j\)</span> for sample <span class="math">\(j\)</span>) associated with them, we can
incorporate this into smoothing, although many of the methods in
<tt class="docutils literal"><span class="pre">scipy</span></tt> and <tt class="docutils literal"><span class="pre">numpy</span></tt> do not directly allow for this.</p>
<p>Instead, we call an optimal interpolation scheme (a regulariser) here
that achieves this. This also has the advantage of giving an estimate of
uncertainty for the smoothed samples.</p>
<p>In this case, the parameters are: <tt class="docutils literal"><span class="pre">order</span></tt> (as above, but only integer
in this implementation) and <tt class="docutils literal"><span class="pre">wsd</span></tt> which is an estimate of the
variation (standard deviation) in the signal that control smoothness.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">tile</span> <span class="o">=</span> <span class="s">&#39;h17v03&#39;</span>
<span class="n">year</span> <span class="o">=</span> <span class="s">&#39;2005&#39;</span>

<span class="c"># specify the file with the urls in</span>
<span class="n">ifile</span><span class="o">=</span> <span class="s">&#39;files/data/modis_lai_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">.txt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
<span class="n">filelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">fp</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
<span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;files/python&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">get_lai</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">]</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;LaiStdDev_1km&#39;</span><span class="p">]</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">lai</span> <span class="o">=</span> <span class="n">read_lai</span><span class="p">(</span><span class="n">filelist</span><span class="p">,</span><span class="n">country</span><span class="o">=</span><span class="s">&#39;IRELAND&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">]</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;LaiStdDev_1km&#39;</span><span class="p">]</span>

<span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">sd</span><span class="p">[</span><span class="n">sd</span><span class="o">&lt;</span><span class="n">thresh</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh</span>

<span class="n">r</span> <span class="o">=</span> <span class="mi">472</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">84</span>
<span class="kn">from</span> <span class="nn">smoothn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># this is about the right amount of smoothing here</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">5.</span>

<span class="n">pixel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
<span class="n">pixel_sd</span> <span class="o">=</span>   <span class="n">sd</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">46</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span>

<span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">smoothn</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span><span class="n">sd</span><span class="o">=</span><span class="n">pixel_sd</span><span class="p">,</span><span class="n">smoothOrder</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c"># plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="s">&#39;k*&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="n">pixel_sd</span><span class="o">*</span><span class="mf">1.96</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;z&#39;</span><span class="p">)</span>
<span class="c"># lower and upper bounds of 95% CI</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.legend.Legend at 0x2b75e4be2790&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_71_1.png" src="../_images/Interpolation_71_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># test it on a new pixel</span>

<span class="n">r</span> <span class="o">=</span> <span class="mi">472</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">86</span>

<span class="n">gamma</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">pixel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
<span class="n">pixel_sd</span> <span class="o">=</span>   <span class="n">sd</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">46</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span>

<span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">smoothn</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span><span class="n">sd</span><span class="o">=</span><span class="n">pixel_sd</span><span class="p">,</span><span class="n">smoothOrder</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c"># plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="s">&#39;k*&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="n">pixel_sd</span><span class="o">*</span><span class="mf">1.96</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;z&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
<span class="n">z</span><span class="o">.</span><span class="n">ndim</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">1</span>
</pre></div>
</div>
<img alt="../_images/Interpolation_72_1.png" src="../_images/Interpolation_72_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># and test it on a new pixel</span>

<span class="n">r</span> <span class="o">=</span> <span class="mi">472</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">84</span>

<span class="c">#r = 9</span>
<span class="c">#c = 277</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">5.</span>

<span class="n">pixel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
<span class="n">pixel_sd</span> <span class="o">=</span>   <span class="n">sd</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">46</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span>

<span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c"># solve for gamma - degree of smoothness</span>
<span class="n">zz</span> <span class="o">=</span> <span class="n">smoothn</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span><span class="n">sd</span><span class="o">=</span><span class="n">pixel_sd</span><span class="p">,</span><span class="n">smoothOrder</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">zz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span> <span class="n">zz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">gamma</span> <span class="o">=</span> <span class="n">zz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c"># plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="s">&#39;k*&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pixel</span><span class="p">,</span><span class="n">pixel_sd</span><span class="o">*</span><span class="mf">1.96</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;z&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>7.56265788653 True
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.legend.Legend at 0x2b75e6878890&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_73_2.png" src="../_images/Interpolation_73_2.png" />
<p>To apply this approach to our 3D dataset, we could simply loop over all
pixels.</p>
<p>Note that <em>any</em> per-pixel processing will be slow ... but this is quite
a fast smoothing method, so is feasible here.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># we have put in an axis control to smoothn</span>
<span class="c"># here so it will only smooth over doy</span>
<span class="c"># This will take a few minutes to process</span>
<span class="c"># we switch on verbose mode to get some feedback</span>
<span class="c"># on progress</span>

<span class="c"># make a mask of pixels where there is at least 1 sample</span>
<span class="c"># over the time period</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">z</span> <span class="o">=</span> <span class="n">smoothn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span><span class="n">sd</span><span class="o">=</span><span class="n">sd</span><span class="p">,</span><span class="n">smoothOrder</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">TolZ</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>tol 1.0 nit 0
tol 1.03767913976 nit 1
tol 0.695375818129 nit 2
tol 0.55340286659 nit 3
tol 0.379048609608 nit 4
tol 0.297133997656 nit 5
tol 0.211254020382 nit 6
tol 0.161703395437 nit 7
tol 0.118022633002 nit 8
tol 0.089141179031 nit 9
tol 0.0662378920796 nit 10
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x2b75d2d9fd40&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_76_1.png" src="../_images/Interpolation_76_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># similarly, take frame 20</span>
<span class="c"># and smooth that</span>

<span class="n">ZZ</span> <span class="o">=</span> <span class="n">smoothn</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span><span class="n">smoothOrder</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span>
<span class="c"># self-calibrated smoothness term</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">print</span> <span class="s">&#39;s =&#39;</span><span class="p">,</span><span class="n">s</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">s</span> <span class="o">=</span> <span class="mf">0.731142059593</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x1857ee18&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_77_2.png" src="../_images/Interpolation_77_2.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># similarly, take frame 20</span>
<span class="c"># and smooth that</span>

<span class="n">ZZ</span> <span class="o">=</span> <span class="n">smoothn</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span><span class="n">smoothOrder</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>tol 1.0 nit 0
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x23289dd0&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_78_2.png" src="../_images/Interpolation_78_2.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">46</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mf">1.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s">&#39;r--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s">&#39;r--&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="s">&#39;r--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="s">&#39;r--&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;LAI variation of Eire&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.text.Text at 0x232b2ed0&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_79_1.png" src="../_images/Interpolation_79_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># or doing this pixel by pixel ...</span>
<span class="c"># which is slower than using axis</span>

<span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c"># pixels that have some data</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">odata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">46</span><span class="p">,)</span> <span class="o">+</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

<span class="n">len_x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">5.</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">len_x</span><span class="p">):</span>
    <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c"># progress bar</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="p">(</span><span class="n">len_x</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;... </span><span class="si">%4.2f</span><span class="s"> percent&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mf">100.</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">len_x</span><span class="p">))</span>
    <span class="n">pixel</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
    <span class="n">pixel_sd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>

    <span class="n">zz</span> <span class="o">=</span> <span class="n">smoothn</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span><span class="n">sd</span><span class="o">=</span><span class="n">pixel_sd</span><span class="p">,</span><span class="n">smoothOrder</span><span class="o">=</span><span class="n">order</span><span class="p">,</span><span class="n">TolZ</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">odata</span><span class="p">[:,</span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="o">...</span> <span class="mf">0.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">5.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">10.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">15.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">20.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">25.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">30.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">35.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">40.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">45.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">50.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">55.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">60.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">65.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">70.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">75.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">80.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">85.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">90.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">95.00</span> <span class="n">percent</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">root</span> <span class="o">=</span> <span class="s">&#39;files/images/lai_eire_colourZ&#39;</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lai</span><span class="p">[</span><span class="s">&#39;filenames&#39;</span><span class="p">]):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="c"># get some info from filename</span>
    <span class="n">file_id</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">print</span> <span class="n">file_id</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">6.</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="c"># plot a jpg</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">.jpg&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">file_id</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">2005001</span>
<span class="mi">2005009</span>
<span class="mi">2005017</span>
<span class="mi">2005025</span>
<span class="mi">2005033</span>
<span class="mi">2005041</span>
<span class="mi">2005049</span>
<span class="mi">2005057</span>
<span class="mi">2005065</span>
<span class="mi">2005073</span>
<span class="mi">2005081</span>
<span class="mi">2005089</span>
<span class="mi">2005097</span>
<span class="mi">2005105</span>
<span class="mi">2005113</span>
<span class="mi">2005121</span>
<span class="mi">2005129</span>
<span class="mi">2005137</span>
<span class="mi">2005145</span>
<span class="mi">2005153</span>
<span class="mi">2005161</span>
<span class="mi">2005169</span>
<span class="mi">2005177</span>
<span class="mi">2005185</span>
<span class="mi">2005193</span>
<span class="mi">2005201</span>
<span class="mi">2005209</span>
<span class="mi">2005217</span>
<span class="mi">2005225</span>
<span class="mi">2005233</span>
<span class="mi">2005241</span>
<span class="mi">2005249</span>
<span class="mi">2005257</span>
<span class="mi">2005265</span>
<span class="mi">2005273</span>
<span class="mi">2005281</span>
<span class="mi">2005289</span>
<span class="mi">2005297</span>
<span class="mi">2005305</span>
<span class="mi">2005313</span>
<span class="mi">2005321</span>
<span class="mi">2005329</span>
<span class="mi">2005337</span>
<span class="mi">2005345</span>
<span class="mi">2005353</span>
<span class="mi">2005361</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;convert -delay 100 -loop 0 {0}_*.jpg {0}_movie2.gif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">0</span>
</pre></div>
</div>
<div class="figure">
<img alt="" src="Chapter5_Interpolation/files/images/lai_eire_colourZ_movie2.gif" />
</div>
</div>
<div class="section" id="function-fitting">
<h3>5.3 Function fitting</h3>
<p>Sometimes, instead of applying some arbitrary smoothing function to
data, we want to extract particular infromation from the time series.</p>
<p>One way to approach this is to fit some function to the time series at
each location.</p>
<p>Let us suppose that we wish to characterise the phenology of vegetation
in Ireland.</p>
<div class="figure">
<img alt="" src="http://www2.geog.ucl.ac.uk/~plewis/geogg124/_images/zhang1.png" />
</div>
<p>One way we could do this would be to look in the lai data for the most
rapid changes.</p>
<p>Another would be to explicitly fit some mathematical function to the LAI
data that would would expect to descrive typical LAI trajectories.</p>
<p>One example of such a function is the double logistic. A logistic
function is:</p>
<div class="math">
\[\hat{y} = p_0 - p_1 \left( \frac{1}{1 + e^{p_2 (t - p_3)}} + \frac{1}{1 + e^{p_4 (t - p_5)}} -1\right)\]</div>
<p>We can give a function for a double logistic:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">dbl_logistic_model</span> <span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A double logistic model, as in Sobrino and Juliean, or Zhang et al&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span> <span class="p">(</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span> <span class="o">+</span> \
                              <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>  <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">tile</span> <span class="o">=</span> <span class="s">&#39;h17v03&#39;</span>
<span class="n">year</span> <span class="o">=</span> <span class="s">&#39;2005&#39;</span>

<span class="c"># specify the file with the urls in</span>
<span class="n">ifile</span><span class="o">=</span> <span class="s">&#39;files/data/modis_lai_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">.txt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
<span class="n">filelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">fp</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
<span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;files/python&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">get_lai</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">]</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;LaiStdDev_1km&#39;</span><span class="p">]</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">lai</span> <span class="o">=</span> <span class="n">read_lai</span><span class="p">(</span><span class="n">filelist</span><span class="p">,</span><span class="n">country</span><span class="o">=</span><span class="s">&#39;IRELAND&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;Lai_1km&#39;</span><span class="p">]</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">lai</span><span class="p">[</span><span class="s">&#39;LaiStdDev_1km&#39;</span><span class="p">]</span>

<span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">sd</span><span class="p">[</span><span class="n">sd</span><span class="o">&lt;</span><span class="n">thresh</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh</span>

<span class="c"># test pixel</span>
<span class="n">r</span> <span class="o">=</span> <span class="mi">472</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">84</span>


<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">y</span><span class="o">.</span><span class="n">mask</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">46</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mf">1.</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">unc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sd</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
</pre></div>
</div>
<p>And see what this looks like:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># define x (time)</span>
<span class="n">x_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">)</span>

<span class="c"># some default values for the parameters</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="c"># some stats on y</span>
<span class="n">ysd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">ymean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c"># some rough guesses at the parameters</span>

<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ymean</span> <span class="o">-</span> <span class="mf">1.151</span><span class="o">*</span><span class="n">ysd</span><span class="p">;</span>   <span class="c"># minimum  (1.151 is 75% CI)</span>
<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mf">1.151</span><span class="o">*</span><span class="n">ysd</span>          <span class="c"># range</span>
<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.19</span>                 <span class="c"># related to up slope</span>
<span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">120</span>                  <span class="c"># midpoint of up slope</span>
<span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.13</span>                 <span class="c"># related to down slope</span>
<span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">220</span>                  <span class="c"># midpoint of down slope</span>

<span class="n">y_hat</span> <span class="o">=</span> <span class="n">dbl_logistic_model</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x_full</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_full</span><span class="p">,</span><span class="n">y_hat</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">unc</span><span class="o">*</span><span class="mf">1.96</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;Container object of 3 artists&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_90_1.png" src="../_images/Interpolation_90_1.png" />
<p>We could manually &#8216;tweak&#8217; the parameters until we got a better &#8216;fit&#8217; to
the observations.</p>
<p>First though, let&#8217;s define a measure of &#8216;fit&#8217;:</p>
<div class="math">
\[Z_i = \frac{\hat{y}_i - y_i}{\sigma_i}\]</div>
<div class="math">
\[Z^2 = \sum_i{Z_i^2} =  \sum_i{\left( \frac{\hat{y}_i - y_i}{\sigma_i} \right)^2}\]</div>
<p>and implement this as a mismatch function where we have data points:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">mismatch_function</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">unc</span><span class="p">):</span>
    <span class="n">y_hat</span> <span class="o">=</span> <span class="n">dbl_logistic_model</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_hat</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">unc</span>
    <span class="k">return</span> <span class="n">diff</span>


<span class="n">Z</span> <span class="o">=</span> <span class="n">mismatch_function</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">unc</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mf">365.</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.</span><span class="p">],</span><span class="s">&#39;k-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">365</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">)</span>


<span class="k">print</span> <span class="s">&#39;Z^2 =&#39;</span><span class="p">,(</span><span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Z</span><span class="o">^</span><span class="mi">2</span> <span class="o">=</span> <span class="mf">113.325251358</span>
</pre></div>
</div>
<img alt="../_images/Interpolation_92_1.png" src="../_images/Interpolation_92_1.png" />
<p>Now lets change p a bit:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ymean</span> <span class="o">-</span> <span class="mf">1.151</span><span class="o">*</span><span class="n">ysd</span><span class="p">;</span>   <span class="c"># minimum  (1.151 is 75% CI)</span>
<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mf">1.151</span><span class="o">*</span><span class="n">ysd</span>          <span class="c"># range</span>
<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.19</span>                 <span class="c"># related to up slope</span>
<span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">140</span>                  <span class="c"># midpoint of up slope</span>
<span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.13</span>                 <span class="c"># related to down slope</span>
<span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">220</span>                  <span class="c"># midpoint of down slope</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">mismatch_function</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">unc</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mf">365.</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.</span><span class="p">],</span><span class="s">&#39;k-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">365</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">)</span>


<span class="k">print</span> <span class="s">&#39;Z^2 =&#39;</span><span class="p">,(</span><span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Z</span><span class="o">^</span><span class="mi">2</span> <span class="o">=</span> <span class="mf">105.478274642</span>
</pre></div>
</div>
<img alt="../_images/Interpolation_94_1.png" src="../_images/Interpolation_94_1.png" />
<p>We have made the mismatch go down a little ...</p>
<p>Clearly it would be tedious (and impractical) to do a lot of such
tweaking, so we can use methods that seek the minimum of some function.</p>
<p>One such method is implemented in <tt class="docutils literal"><span class="pre">scipy.optimize.leastsq</span></tt>:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>

<span class="c"># initial estimate is in p</span>
<span class="k">print</span> <span class="s">&#39;initial parameters:&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

<span class="c"># set some bounds for the parameters</span>
<span class="n">bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">10.</span><span class="p">),(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">10.</span><span class="p">),(</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">1.</span><span class="p">),(</span><span class="mf">50.</span><span class="p">,</span><span class="mf">300.</span><span class="p">),(</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">1.</span><span class="p">),(</span><span class="mf">50.</span><span class="p">,</span><span class="mf">300.</span><span class="p">)])</span>


<span class="c"># test pixel</span>
<span class="n">r</span> <span class="o">=</span> <span class="mi">472</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">84</span>


<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">y</span><span class="o">.</span><span class="n">mask</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">46</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mf">1.</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">unc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sd</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

<span class="c"># define function to give Z^2</span>

<span class="k">def</span> <span class="nf">sse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">unc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Sum of squared error&#39;&#39;&#39;</span>
    <span class="c"># penalise p[3] &gt; p[5]</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">0.</span><span class="p">,(</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">])])</span><span class="o">*</span><span class="mf">1e4</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mismatch_function</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">unc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">+</span><span class="n">err</span>

<span class="c"># we pass the function:</span>
<span class="c">#</span>
<span class="c"># sse               : the name of the function we wrote to give</span>
<span class="c">#                     sum of squares of Z_i</span>
<span class="c"># p                 : an initial estimate of the parameters</span>
<span class="c"># args=(x,y,unc)    : the other information (other than p) that</span>
<span class="c">#                     mismatch_function needs</span>
<span class="c"># approx_grad       : if we dont have a function for the gradien</span>
<span class="c">#                     we have to get the solver to approximate it</span>
<span class="c">#                     which takes time ... see if you can work out</span>
<span class="c">#                     d_sse / dp and use that to speed this up!</span>

<span class="n">psolve</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin_l_bfgs_b</span><span class="p">(</span><span class="n">sse</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">approx_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">iprint</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>\
                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">unc</span><span class="p">),</span><span class="n">bounds</span><span class="o">=</span><span class="n">bound</span><span class="p">)</span>

<span class="k">print</span> <span class="n">psolve</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">pp</span> <span class="o">=</span> <span class="n">psolve</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">unc</span><span class="o">*</span><span class="mf">1.96</span><span class="p">)</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">dbl_logistic_model</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span><span class="n">x_full</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_full</span><span class="p">,</span><span class="n">y_hat</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;solved parameters: &#39;</span><span class="p">,</span><span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

<span class="c"># if we define the phenology as the parameter p[3]</span>
<span class="c"># and the &#39;length&#39; of the growing season:</span>
<span class="k">print</span> <span class="s">&#39;phenology&#39;</span><span class="p">,</span><span class="n">pp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">pp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>initial parameters: 1.04703335612 1.62445180627 0.19 140.0 0.13 220.0
23.2882812239
solved parameters:  0.614031423522 2.92120123969 0.0357337165804 159.497584338 0.0381324783625 227.002721261
phenology 159.497584338 67.5051369225
</pre></div>
</div>
<img alt="../_images/Interpolation_96_1.png" src="../_images/Interpolation_96_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># and run over each pixel ... this will take some time</span>

<span class="c"># pixels that have some data</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">pdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">7</span><span class="p">,)</span> <span class="o">+</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
<span class="n">len_x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

<span class="c"># lets just do some random ones to start with</span>
<span class="c">#rows = rows[::10]</span>
<span class="c">#cols = cols[::10]</span>

<span class="n">len_x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">len_x</span><span class="p">):</span>
    <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c"># progress bar</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="p">(</span><span class="n">len_x</span><span class="o">/</span><span class="mi">40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;... </span><span class="si">%4.2f</span><span class="s"> percent&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mf">100.</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">len_x</span><span class="p">))</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">y</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">46</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mf">1.</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">unc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sd</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

    <span class="c"># need to get an initial estimate of the parameters</span>

    <span class="c"># some stats on y</span>
    <span class="n">ysd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">ymean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ymean</span> <span class="o">-</span> <span class="mf">1.151</span><span class="o">*</span><span class="n">ysd</span><span class="p">;</span>   <span class="c"># minimum  (1.151 is 75% CI)</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mf">1.151</span><span class="o">*</span><span class="n">ysd</span>          <span class="c"># range</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.19</span>                 <span class="c"># related to up slope</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">140</span>                  <span class="c"># midpoint of up slope</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.13</span>                 <span class="c"># related to down slope</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">220</span>                  <span class="c"># midpoint of down slope</span>


    <span class="c"># set factr to quite large number (relative error in solution)</span>
    <span class="c"># as it&#39;ll take too long otherwise</span>
    <span class="n">psolve</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin_l_bfgs_b</span><span class="p">(</span><span class="n">sse</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">approx_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">iprint</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>\
                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">unc</span><span class="p">),</span><span class="n">bounds</span><span class="o">=</span><span class="n">bound</span><span class="p">,</span><span class="n">factr</span><span class="o">=</span><span class="mf">1e12</span><span class="p">)</span>

    <span class="n">pdata</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">psolve</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pdata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">psolve</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c"># sse</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="o">...</span> <span class="mf">0.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">2.50</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">5.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">7.50</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">10.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">12.50</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">15.00</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">17.50</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">19.99</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">22.49</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">24.99</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">27.49</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">29.99</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">32.49</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">34.99</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">37.49</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">39.99</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">42.49</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">44.99</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">47.49</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">49.99</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">52.49</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">54.99</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">57.49</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">59.98</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">62.48</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">64.98</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">67.48</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">69.98</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">72.48</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">74.98</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">77.48</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">79.98</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">82.48</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">84.98</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">87.48</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">89.98</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">92.48</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">94.98</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">97.47</span> <span class="n">percent</span>
<span class="o">...</span> <span class="mf">99.97</span> <span class="n">percent</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pdata</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">137</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">141</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;green up doy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pdata</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">pdata</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">74</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">84</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;season length&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">6.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;min LAI&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">6.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;max LAI&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pdata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;RSSE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x2b75e5deefc8&gt;
</pre></div>
</div>
<img alt="../_images/Interpolation_98_1.png" src="../_images/Interpolation_98_1.png" />
<img alt="../_images/Interpolation_98_2.png" src="../_images/Interpolation_98_2.png" />
<img alt="../_images/Interpolation_98_3.png" src="../_images/Interpolation_98_3.png" />
<img alt="../_images/Interpolation_98_4.png" src="../_images/Interpolation_98_4.png" />
<img alt="../_images/Interpolation_98_5.png" src="../_images/Interpolation_98_5.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># check a few pixels</span>

<span class="n">c</span> <span class="o">=</span> <span class="mi">200</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">400</span><span class="p">,</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">y</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">46</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mf">1.</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">unc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sd</span><span class="p">[:,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

    <span class="n">x_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">)</span>

    <span class="c"># some default values for the parameters</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;r </span><span class="si">%d</span><span class="s"> c </span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">unc</span><span class="o">*</span><span class="mf">1.96</span><span class="p">)</span>
    <span class="n">y_hat</span> <span class="o">=</span> <span class="n">dbl_logistic_model</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span><span class="n">x_full</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_full</span><span class="p">,</span><span class="n">y_hat</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&#39;solved parameters: &#39;</span><span class="p">,</span><span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

    <span class="c"># if we define the phenology as the parameter p[3]</span>
    <span class="c"># and the &#39;length&#39; of the growing season:</span>
    <span class="k">print</span> <span class="s">&#39;phenology&#39;</span><span class="p">,</span><span class="n">pp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">pp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>solved parameters:  0.837899998448 2.82427082241 0.0164922480786 139.933827392 0.015218312802 219.620042827
phenology 139.933827392 79.6862154345
solved parameters:  1.25111026954 2.3270241822 0.0190331997407 137.746147061 0.0650489530419 220.049105733
phenology 137.746147061 82.3029586718
solved parameters:  1.24735745202 2.64641924245 0.01 139.923207754 0.0103960017819 220.21982824
phenology 139.923207754 80.2966204854
solved parameters:  0.932759824658 2.57001493023 0.0499114191497 141.274250409 1.0 220.241108243
phenology 141.274250409 78.9668578339
solved parameters:  3.3118926764 10.0 0.0227526645775 141.59060759 0.0129963184052 218.391152509
phenology 141.59060759 76.8005449187
solved parameters:  1.00690819411 2.5680266473 0.0244446244614 139.049623755 0.0196297496409 220.194411837
phenology 139.049623755 81.1447880828
solved parameters:  1.41787972842 0.735065812424 0.183737093991 139.730989265 0.0642603310649 219.975475755
phenology 139.730989265 80.2444864894
solved parameters:  1.03836639365 1.58477670269 0.0296244335923 139.895942883 0.0436631925744 220.03650496
phenology 139.895942883 80.1405620773
</pre></div>
</div>
<img alt="../_images/Interpolation_99_1.png" src="../_images/Interpolation_99_1.png" />
<img alt="../_images/Interpolation_99_2.png" src="../_images/Interpolation_99_2.png" />
<img alt="../_images/Interpolation_99_3.png" src="../_images/Interpolation_99_3.png" />
<img alt="../_images/Interpolation_99_4.png" src="../_images/Interpolation_99_4.png" />
<img alt="../_images/Interpolation_99_5.png" src="../_images/Interpolation_99_5.png" />
<img alt="../_images/Interpolation_99_6.png" src="../_images/Interpolation_99_6.png" />
<img alt="../_images/Interpolation_99_7.png" src="../_images/Interpolation_99_7.png" />
<img alt="../_images/Interpolation_99_8.png" src="../_images/Interpolation_99_8.png" />
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
        &copy; Copyright 2014, Prof. P. Lewis.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>