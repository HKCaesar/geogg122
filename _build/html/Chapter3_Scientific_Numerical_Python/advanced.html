

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>A3. Advanced notes: Scientific and Numerical Python &mdash; GeogG122: Scientific Computing v&lt;release&gt; documentation</title>
    
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="top" title="GeogG122: Scientific Computing v&lt;release&gt; documentation" href="../index.html" />
    <link rel="next" title="E3.3: Exercise: Improved Solar Radiation Modelling" href="advanced_answers.html" />
    <link rel="prev" title="E2. Exercises" href="../Chapter2_Python_intro/main_answers.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="advanced_answers.html" title="E3.3: Exercise: Improved Solar Radiation Modelling"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../Chapter2_Python_intro/main_answers.html" title="E2. Exercises"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">geogg122</a> &raquo;</li>
 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="a3-advanced-notes-scientific-and-numerical-python">
<h1>A3. Advanced notes: Scientific and Numerical Python<a class="headerlink" href="#a3-advanced-notes-scientific-and-numerical-python" title="Permalink to this headline">¶</a></h1>
<div class="section" id="a3-1-pulling-compressed-netcdf-files">
<h2>A3.1 Pulling Compressed netCDF Files<a class="headerlink" href="#a3-1-pulling-compressed-netcdf-files" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, such as when we want to pull data from netCDF files from some
data site such as <a class="reference external" href="http://www.globalbedo.org">http://www.globalbedo.org</a>, we might find that &#8216;older
style&#8217; formats have been used, such as netCDF3 which might not have
internal compression.</p>
<p>To save storage space, it is common to compress such files extrenally
(i.e. to gzip a file).</p>
<p>That makes direct reading from a url a bit more tricky, and in such
cases, we may as well uncompress the file to a local temporary file.</p>
<div class="section" id="doing-this-in-python">
<h3>Doing this in Python<a class="headerlink" href="#doing-this-in-python" title="Permalink to this headline">¶</a></h3>
<p>What we are going to do is to write a class to download a gzipped file
from a url and return a filename that can be read by other functions.</p>
<p>The file is available as <a class="reference external" href="files/python/gzurl.py">gzurl.py</a>, in the
directory <tt class="docutils literal"><span class="pre">files/python</span></tt>.</p>
<p>To be able to import this, we have to put <tt class="docutils literal"><span class="pre">files/python</span></tt> in the path
where Python looks for modules:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>
<span class="c"># put local directory into the path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;files</span><span class="si">%s</span><span class="s">python&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>

<span class="c"># import module</span>
<span class="kn">from</span> <span class="nn">gzurl</span> <span class="kn">import</span> <span class="n">gzurl</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">help</span><span class="p">(</span><span class="n">gzurl</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>Help on class gzurl in module gzurl:

class gzurl(__builtin__.object)
 |  Download gzipped url to a local file or string
 |
 |  Prof. P. Lewis, UCL,
 |  Thu 10 Oct 2013 12:01:00 BST
 |  p.lewis@ucl.ac.uk
 |
 |  Methods defined here:
 |
 |  __del__(self)
 |      Destriuctor
 |
 |      Tidy up
 |
 |  __init__(self, url, filename=None, store=False, file=True)
 |      initialise class instance
 |
 |      Parameters:
 |
 |      url   : url of gzipped file
 |
 |      Options:
 |
 |      filename:
 |              specify a filename explicitly, rather than
 |              a temporary file (default None)
 |      store : boolean flag to store the uncompressed
 |              data in self.data (default false)
 |      file  : boolean flag to store data to a file
 |              (default True)
 |
 |  close(self)
 |      Tidy up
 |
 |  read(self, url)
 |      read gzipped data from url
 |      and uncompress
 |
 |  ----------------------------------------------------------------------
 |  Data descriptors defined here:
 |
 |  __dict__
 |      dictionary for instance variables (if defined)
 |
 |  __weakref__
 |      list of weak references to the object (if defined)
</pre></div>
</div>
<p>You can look through the file <tt class="docutils literal"><span class="pre">`gzurl.py</span></tt> &lt;files/python/gzurl.py&gt;`__
at your leisure, but it is of interest to see how we have done this.</p>
<p>We need to load the following modules to do this:</p>
<p><tt class="docutils literal"><span class="pre">urllib2,</span> <span class="pre">io,</span> <span class="pre">gzip,</span> <span class="pre">tempfile</span></tt>:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">urllib2</span><span class="o">,</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">tempfile</span>
</pre></div>
</div>
<p>The first thing we do is attempt to open a file specified from a url:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># codes for url specification on globalbedo.org</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1998</span><span class="p">,</span><span class="mi">2012</span><span class="p">)</span>
<span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">95</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">78</span><span class="p">]</span>
<span class="n">XX</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">codes</span><span class="p">))</span>

<span class="n">year</span> <span class="o">=</span> <span class="mi">2009</span>

<span class="n">root</span> <span class="o">=</span> <span class="s">&#39;http://www.globalbedo.org/GlobAlbedo</span><span class="si">%d</span><span class="s">/mosaics/</span><span class="si">%d</span><span class="s">/0.5/monthly/&#39;</span><span class="o">%</span>\
        <span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="n">year</span><span class="p">],</span><span class="n">year</span><span class="p">)</span>

<span class="c"># filename formatting string: use %02d for month eg 01 for 1</span>
<span class="n">month</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="s">&#39;/GlobAlbedo.</span><span class="si">%d%02d</span><span class="s">.mosaic.5.nc.gz&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)</span>
<span class="k">print</span> <span class="n">url</span>

<span class="c"># open file from url</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>http://www.globalbedo.org/GlobAlbedo56/mosaics/2009/0.5/monthly//GlobAlbedo.200901.mosaic.5.nc.gz
</pre></div>
</div>
<p>We then read data from that with the statement:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">bdata</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c"># which looks like this:</span>
<span class="n">bdata</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span>
</pre></div>
</div>
<pre class="literal-block">
'x1fx8bx08x08xf5xe71Rx00x03GlobAlbedo.200901.mosaic.5.ncx00xecxdbwxTUxfexc7qx10'
</pre>
<p>We then create a buffered I/O stream from this using io.BytesIO, which
is the form we want the information in for the next part:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">fileobj</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p>Next, we use the module <tt class="docutils literal"><span class="pre">gzip.GzipFile</span></tt> which simulates the methods of
a gzip file:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">fileobj</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;gzip _io.BytesIO object at 0x105aea950 0x105bd2890&gt;
</pre></div>
</div>
<p>And then we read from this:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">data</span><span class="o">=</span><span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>This is now binary of netCDF format in this case.</p>
<p>Next, we need to write these data to a file. In this case, we don&#8217;t want
to really save the data anywhere, so we want to use a temporary file.</p>
<p>In Python, you can create a temporary file using the module tempfile,
which creates a temporary (unique) file on the system.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span> <span class="n">tmp</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>/var/folders/pt/z0y8dmcd7d77cs_0hnygpwh80000gn/T/tmpN1LPzf
</pre></div>
</div>
<p>So we write the data to this file:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, after we have done something with the data, we will want to tidy
up and delete the file:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">tmp</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>To use this module then:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>
<span class="c"># put local directory into the path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;python&#39;</span><span class="p">))</span>
<span class="c"># import local module gzurl</span>
<span class="kn">from</span> <span class="nn">gzurl</span> <span class="kn">import</span> <span class="n">gzurl</span>
<span class="kn">import</span> <span class="nn">gdal</span>

<span class="k">def</span> <span class="nf">readGA</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s">&#39;data/&#39;</span><span class="p">,</span><span class="n">year</span><span class="o">=</span><span class="mi">2009</span><span class="p">,</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">layer</span> <span class="o">=</span> <span class="s">&#39;BHR_VIS&#39;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Method to read a GlobAlbedo file from earlier</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">file_template</span> <span class="o">=</span> <span class="s">&#39;NETCDF:&quot;</span><span class="si">%s</span><span class="s">&quot;:</span><span class="si">%s</span><span class="s">&#39;</span>

    <span class="c"># allow filename to be overridden from filename=</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="n">root</span> <span class="o">+</span> <span class="s">&#39;GlobAlbedo.</span><span class="si">%d%02d</span><span class="s">.mosaic.5.nc&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span> <span class="p">(</span>  <span class="n">file_template</span> <span class="o">%</span> <span class="p">(</span> <span class="n">filename</span><span class="p">,</span> <span class="n">layer</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>

    <span class="c"># return a numpy array</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>


<span class="c"># codes for url specification on globalbedo.org</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1998</span><span class="p">,</span><span class="mi">2012</span><span class="p">)</span>
<span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">95</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">78</span><span class="p">]</span>
<span class="n">XX</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">codes</span><span class="p">))</span>

<span class="n">year</span> <span class="o">=</span> <span class="mi">2009</span>

<span class="n">root</span> <span class="o">=</span> <span class="s">&#39;http://www.globalbedo.org/GlobAlbedo</span><span class="si">%d</span><span class="s">/mosaics/</span><span class="si">%d</span><span class="s">/0.5/monthly/&#39;</span><span class="o">%</span>\
        <span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="n">year</span><span class="p">],</span><span class="n">year</span><span class="p">)</span>

<span class="k">print</span> <span class="n">root</span>

<span class="c"># filename formatting string: use %02d for month eg 01 for 1</span>
<span class="n">month</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="s">&#39;/GlobAlbedo.</span><span class="si">%d%02d</span><span class="s">.mosaic.5.nc.gz&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)</span>

<span class="c"># read the gzipped file</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">gzurl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="c"># read the netCDF file from f.filename</span>
<span class="n">nc</span> <span class="o">=</span> <span class="n">readGA</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
<span class="k">print</span> <span class="n">nc</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>http://www.globalbedo.org/GlobAlbedo56/mosaics/2009/0.5/monthly/
[[        nan         nan         nan ...,         nan         nan
          nan]
 [        nan         nan         nan ...,         nan         nan
          nan]
 [        nan         nan         nan ...,         nan         nan
          nan]
 ...,
 [ 0.67017049  0.67017049  0.67017049 ...,  0.67199522  0.67199522
   0.67199522]
 [ 0.67017049  0.67017049  0.67017049 ...,  0.67199522  0.67199522
   0.67199522]
 [ 0.67017049  0.67017049  0.67017049 ...,  0.67199522  0.67199522
   0.67199522]]
</pre></div>
</div>
<p>Alternatively, to read all of the files into the directory files/data
for the year 2011 and keep them:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>
<span class="c"># put local directory into the path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;files</span><span class="si">%s</span><span class="s">python&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>
<span class="c"># import local module gzurl</span>
<span class="kn">from</span> <span class="nn">gzurl</span> <span class="kn">import</span> <span class="n">gzurl</span>
<span class="kn">import</span> <span class="nn">gdal</span>

<span class="c"># codes for url specification on globalbedo.org</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1998</span><span class="p">,</span><span class="mi">2012</span><span class="p">)</span>
<span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">95</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">78</span><span class="p">]</span>
<span class="n">XX</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">codes</span><span class="p">))</span>

<span class="n">year</span> <span class="o">=</span> <span class="mi">2009</span>

<span class="n">root</span> <span class="o">=</span> <span class="s">&#39;http://www.globalbedo.org/GlobAlbedo</span><span class="si">%d</span><span class="s">/mosaics/</span><span class="si">%d</span><span class="s">/0.5/monthly/&#39;</span><span class="o">%</span>\
        <span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="n">year</span><span class="p">],</span><span class="n">year</span><span class="p">)</span>

<span class="k">for</span> <span class="n">month0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="c"># filename formatting string: use %02d for month eg 01 for 1</span>
    <span class="n">base</span> <span class="o">=</span> <span class="s">&#39;GlobAlbedo.</span><span class="si">%d%02d</span><span class="s">.mosaic.5.nc&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month0</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="n">base</span> <span class="o">+</span> <span class="s">&#39;.gz&#39;</span>
    <span class="c"># specify a local filename</span>
    <span class="c"># work out how / why this works ...</span>
    <span class="n">local</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;data{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">),</span><span class="n">base</span><span class="p">)</span>

    <span class="c"># read the gzipped file</span>
    <span class="k">print</span> <span class="n">local</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">gzurl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="n">local</span><span class="p">)</span>
    <span class="c"># read the netCDF file from f.filename</span>
    <span class="c"># read the gzipped file</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="n">readGA</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>data/GlobAlbedo.200901.mosaic.5.nc
data/GlobAlbedo.200902.mosaic.5.nc
data/GlobAlbedo.200903.mosaic.5.nc
data/GlobAlbedo.200904.mosaic.5.nc
data/GlobAlbedo.200905.mosaic.5.nc
data/GlobAlbedo.200906.mosaic.5.nc
data/GlobAlbedo.200907.mosaic.5.nc
data/GlobAlbedo.200908.mosaic.5.nc
data/GlobAlbedo.200909.mosaic.5.nc
data/GlobAlbedo.200910.mosaic.5.nc
data/GlobAlbedo.200911.mosaic.5.nc
data/GlobAlbedo.200912.mosaic.5.nc
</pre></div>
</div>
</div>
<div class="section" id="doing-this-in-unix">
<h3>Doing this in unix<a class="headerlink" href="#doing-this-in-unix" title="Permalink to this headline">¶</a></h3>
<p>That&#8217;s not too complicated, but you might often do this sort of thing
from unix instead:</p>
<div class="code python highlight-python"><div class="highlight"><pre>!rm -f data/GlobAlbedo.200901.mosaic.5.nc.gz
!wget -O data/GlobAlbedo.200901.mosaic.5.nc.gz \
  http://www.globalbedo.org/GlobAlbedo56/mosaics/2009/0.5/monthly/GlobAlbedo.200901.mosaic.5.nc.gz
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>--2014-10-07 14:03:42--  http://www.globalbedo.org/GlobAlbedo56/mosaics/2009/0.5/monthly/GlobAlbedo.200901.mosaic.5.nc.gz
Resolving www.globalbedo.org... 128.40.73.100
Connecting to www.globalbedo.org|128.40.73.100|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 4540366 (4.3M) [application/x-gzip]
Saving to: `data/GlobAlbedo.200901.mosaic.5.nc.gz&#39;

100%[======================================&gt;] 4,540,366   21.6M/s   in 0.2s

2014-10-07 14:03:42 (21.6 MB/s) - `data/GlobAlbedo.200901.mosaic.5.nc.gz&#39; saved [4540366/4540366]
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre>!gunzip -f data/GlobAlbedo.200901.mosaic.5.nc.gz
!ls -l data/GlobAlbedo.200901.mosaic.5.nc
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>-rw-rw-r--. 1 plewis plewis 18669672 Sep 12  2013 data/GlobAlbedo.200901.mosaic.5.nc
</pre></div>
</div>
</div>
</div>
<div class="section" id="a3-2-logical-combinations-in-numpy">
<h2>A3.2 Logical combinations in numpy<a class="headerlink" href="#a3-2-logical-combinations-in-numpy" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s read in a different GlobAlbedo dataset.</p>
<p>This time, we will read 8 day tile data (day of year: <tt class="docutils literal"><span class="pre">001</span></tt>, <tt class="docutils literal"><span class="pre">009</span></tt>
etc. every 8 days).</p>
<p>The tile we will read is <tt class="docutils literal"><span class="pre">h17v03</span></tt> which covers most of the UK.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;files</span><span class="si">%s</span><span class="s">python&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">gzurl</span> <span class="kn">import</span> <span class="n">gzurl</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="n">years</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1998</span><span class="p">,</span><span class="mi">2012</span><span class="p">)</span>
<span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">95</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">78</span><span class="p">]</span>
<span class="n">XX</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">codes</span><span class="p">))</span>

<span class="n">year</span> <span class="o">=</span> <span class="mi">2009</span>
<span class="n">tile</span> <span class="o">=</span> <span class="s">&#39;h17v03&#39;</span>

<span class="n">root</span> <span class="o">=</span> <span class="s">&#39;http://www.globalbedo.org/GlobAlbedo</span><span class="si">%d</span><span class="s">/tiles/</span><span class="si">%d</span><span class="s">/</span><span class="si">%s</span><span class="s">/&#39;</span><span class="o">%</span>\
        <span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="n">year</span><span class="p">],</span><span class="n">year</span><span class="p">,</span><span class="n">tile</span><span class="p">)</span>

<span class="c"># filename formatting string: use %03d for doy eg 001 for 1</span>
<span class="n">doy</span> <span class="o">=</span> <span class="mi">145</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="s">&#39;GlobAlbedo.</span><span class="si">%d%03d</span><span class="s">.</span><span class="si">%s</span><span class="s">.nc.gz&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">doy</span><span class="p">,</span><span class="n">tile</span><span class="p">)</span>
<span class="c"># see if you can make sense of this complicated formatting</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.gz&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="n">local_file</span> <span class="o">=</span> <span class="s">&#39;files{0}data{0}{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>

<span class="c"># try to read local file</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">gzurl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="n">local_file</span><span class="p">)</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># now pull some data</span>

<span class="n">vis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;BHR_VIS&#39;</span><span class="p">])</span>
<span class="n">nir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;BHR_NIR&#39;</span><span class="p">])</span>
<span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">vis</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">vis</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>-c:5: RuntimeWarning: invalid value encountered in divide
</pre></div>
</div>
<p>Now plot it:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="c"># figure size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="c"># title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;NDVI: Tile </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> doy </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doy</span><span class="p">))</span>
<span class="c"># colour map</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>
<span class="c"># plot the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="c"># colour bar</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x10687ce60&gt;
</pre></div>
</div>
<img alt="../_images/advanced_38_1.png" src="../_images/advanced_38_1.png" />
<p>We notice in this dataset that there are some &#8216;funnies&#8217; (unreliable
data) around the coastline, which are probably due to negative
reflectance values.</p>
<p>We could try, for instance to build a mask for these, supposing them to
be some other &#8216;invalid&#8217; number, but in this dataset, we have some other
data layers that can help:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="s">u&#39;metadata&#39;</span><span class="p">,</span>
 <span class="s">u&#39;DHR_VIS&#39;</span><span class="p">,</span>
 <span class="s">u&#39;DHR_NIR&#39;</span><span class="p">,</span>
 <span class="s">u&#39;DHR_SW&#39;</span><span class="p">,</span>
 <span class="s">u&#39;BHR_VIS&#39;</span><span class="p">,</span>
 <span class="s">u&#39;BHR_NIR&#39;</span><span class="p">,</span>
 <span class="s">u&#39;BHR_SW&#39;</span><span class="p">,</span>
 <span class="s">u&#39;DHR_sigmaVIS&#39;</span><span class="p">,</span>
 <span class="s">u&#39;DHR_sigmaNIR&#39;</span><span class="p">,</span>
 <span class="s">u&#39;DHR_sigmaSW&#39;</span><span class="p">,</span>
 <span class="s">u&#39;BHR_sigmaVIS&#39;</span><span class="p">,</span>
 <span class="s">u&#39;BHR_sigmaNIR&#39;</span><span class="p">,</span>
 <span class="s">u&#39;BHR_sigmaSW&#39;</span><span class="p">,</span>
 <span class="s">u&#39;Weighted_Number_of_Samples&#39;</span><span class="p">,</span>
 <span class="s">u&#39;Relative_Entropy&#39;</span><span class="p">,</span>
 <span class="s">u&#39;Goodness_of_Fit&#39;</span><span class="p">,</span>
 <span class="s">u&#39;Snow_Fraction&#39;</span><span class="p">,</span>
 <span class="s">u&#39;Data_Mask&#39;</span><span class="p">,</span>
 <span class="s">u&#39;Solar_Zenith_Angle&#39;</span><span class="p">,</span>
 <span class="s">u&#39;lat&#39;</span><span class="p">,</span>
 <span class="s">u&#39;lon&#39;</span><span class="p">,</span>
 <span class="s">u&#39;crs&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># better have a look at the individual bands as well</span>
<span class="c"># plot the vis and nir bands</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;VIS: Tile </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> doy </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doy</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;NIR: Tile </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> doy </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doy</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nir</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x107236d88&gt;
</pre></div>
</div>
<img alt="../_images/advanced_41_1.png" src="../_images/advanced_41_1.png" />
<img alt="../_images/advanced_41_2.png" src="../_images/advanced_41_2.png" />
<p>Apart from a few minor outliers, these data look fine.</p>
<p>Let&#8217;s try developing a mask from <tt class="docutils literal"><span class="pre">Data_Mask</span></tt>:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;Data_Mask&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

<span class="c"># plot it</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Data_Mask: Tile </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> doy </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doy</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x1068ab710&gt;
</pre></div>
</div>
<img alt="../_images/advanced_43_1.png" src="../_images/advanced_43_1.png" />
<p>The mask is <tt class="docutils literal"><span class="pre">True</span></tt> where there are valid (land) data.</p>
<p>In a masked array, we want the opposite of this.</p>
<p>We can&#8217;r directly use <tt class="docutils literal"><span class="pre">not</span></tt>, but we can use the bitwise operatoe
<tt class="docutils literal"><span class="pre">~</span></tt>:</p>
<p>Use the mask in a masked array:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>

<span class="n">vis</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">mask</span><span class="o">=~</span><span class="n">mask</span><span class="p">)</span>
<span class="n">nir</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nir</span><span class="p">,</span><span class="n">mask</span><span class="o">=~</span><span class="n">mask</span><span class="p">)</span>
<span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">vis</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">vis</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;NDVI: Tile </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> doy </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doy</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x1072aa290&gt;
</pre></div>
</div>
<img alt="../_images/advanced_45_1.png" src="../_images/advanced_45_1.png" />
<p>The data mask hasn&#8217;t solved the problem for NDVI then.</p>
<p>A problem might arise from a small number of negative reflectance values
in the dataset.</p>
<p>We can create masks for these:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">mask1</span> <span class="o">=</span> <span class="n">vis</span> <span class="o">&lt;</span> <span class="mf">0.</span>
<span class="n">mask2</span> <span class="o">=</span> <span class="n">nir</span> <span class="o">&lt;</span> <span class="mi">0</span>
<span class="k">print</span> <span class="s">&#39;number of -ve VIS pixels&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask1</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;number of -ve NIR pixels&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>number of -ve VIS pixels 317
number of -ve NIR pixels 934
</pre></div>
</div>
<p>and we can combine them with a bitwise operator, <tt class="docutils literal"><span class="pre">|</span></tt> (or) or <tt class="docutils literal"><span class="pre">&amp;</span></tt>
(and) in this case (reversing the conditions):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;Data_Mask&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">vis</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="c"># plot it</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Data_Mask: Tile </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> doy </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doy</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x107c865f0&gt;
</pre></div>
</div>
<img alt="../_images/advanced_49_1.png" src="../_images/advanced_49_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">vis</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">mask</span><span class="o">=~</span><span class="n">mask</span><span class="p">)</span>
<span class="n">nir</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nir</span><span class="p">,</span><span class="n">mask</span><span class="o">=~</span><span class="n">mask</span><span class="p">)</span>
<span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">vis</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">vis</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;NDVI: Tile </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> doy </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doy</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x107320830&gt;
</pre></div>
</div>
<img alt="../_images/advanced_50_1.png" src="../_images/advanced_50_1.png" />
<p>This hasn&#8217;t entirely sorted it either.</p>
<p>Next have a look at a few more fields before going further:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># demonstration of multiple subplots</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="s">&#39;DHR_VIS&#39;</span><span class="p">,</span><span class="s">&#39;DHR_NIR&#39;</span><span class="p">],</span>\
                     <span class="p">[</span><span class="s">&#39;DHR_sigmaVIS&#39;</span><span class="p">,</span><span class="s">&#39;DHR_sigmaNIR&#39;</span><span class="p">],</span>\
                     <span class="p">[</span><span class="s">&#39;Data_Mask&#39;</span><span class="p">,</span><span class="s">&#39;Weighted_Number_of_Samples&#39;</span><span class="p">]])</span>

<span class="c"># load up all datasets in dict data</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">dlist</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dlist</span><span class="p">:</span>
    <span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

<span class="n">mask</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s">&#39;Data_Mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span> \
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_VIS&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">|</span> \
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_NIR&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">))</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">shape</span>

<span class="c"># how big for each subplot ?</span>
<span class="n">big</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c"># set the figure size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">big</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">big</span><span class="p">))</span>

<span class="c"># colorbars for subplots are a bit tricky</span>
<span class="c"># here&#39;s one way of sorting this</span>
<span class="c"># using dataset shapes</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c"># colour map</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d0</span><span class="p">):</span>

        <span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">],</span><span class="n">mask</span><span class="o">=~</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="c"># no axis ticks</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

        <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>


<span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_NIR&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_VIS&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_NIR&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_VIS&#39;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;NDVI: Tile </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> doy </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doy</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x116dd8ab8&gt;
</pre></div>
</div>
<img alt="../_images/advanced_52_1.png" src="../_images/advanced_52_1.png" />
<img alt="../_images/advanced_52_2.png" src="../_images/advanced_52_2.png" />
<p>So it looks as though we need to filter on
<tt class="docutils literal"><span class="pre">'Weighted_Number_of_Samples'</span></tt> as well, and perhaps on uncertainty:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># demonstration of multiple subplots</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="s">&#39;DHR_VIS&#39;</span><span class="p">,</span><span class="s">&#39;DHR_NIR&#39;</span><span class="p">],</span>\
                     <span class="p">[</span><span class="s">&#39;DHR_sigmaVIS&#39;</span><span class="p">,</span><span class="s">&#39;DHR_sigmaNIR&#39;</span><span class="p">],</span>\
                     <span class="p">[</span><span class="s">&#39;Data_Mask&#39;</span><span class="p">,</span><span class="s">&#39;Weighted_Number_of_Samples&#39;</span><span class="p">]])</span>

<span class="c"># load up all datasets in dict data</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">dlist</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dlist</span><span class="p">:</span>
    <span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

<span class="n">mask</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s">&#39;Data_Mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span> <span class="o">&amp;</span> \
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Weighted_Number_of_Samples&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> \
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_sigmaVIS&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.8</span><span class="p">)</span> <span class="o">&amp;</span> \
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_sigmaNIR&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.8</span><span class="p">)</span> <span class="o">&amp;</span> \
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_VIS&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span> \
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_NIR&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">shape</span>

<span class="c"># how big for each subplot ?</span>
<span class="n">big</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c"># set the figure size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">big</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">big</span><span class="p">))</span>

<span class="c"># colorbars for subplots are a bit tricky</span>
<span class="c"># here&#39;s one way of sorting this</span>
<span class="c"># using dataset shapes</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c"># colour map</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d0</span><span class="p">):</span>

        <span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">],</span><span class="n">mask</span><span class="o">=~</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="c"># no axis ticks</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

        <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/advanced_54_0.png" src="../_images/advanced_54_0.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_NIR&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_VIS&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_NIR&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;DHR_VIS&#39;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">13</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;NDVI: Tile </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> doy </span><span class="si">%03d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">doy</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;Spectral&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.colorbar.Colorbar instance at 0x115bb1cb0&gt;
</pre></div>
</div>
<img alt="../_images/advanced_55_1.png" src="../_images/advanced_55_1.png" />
<p>Thats quite a bit better, but still not perfect.</p>
<p><strong>Experiment with the conditions of the masking to see how you can get
rid of the odd pixels (the &#8216;red&#8217; ones in the above). Do *not* filter on
``ndvi`` itself, as we *might* be interested in negative ``ndvi`` values
in some cases.</strong></p>
<p>Once you think you have some useful filtering conditions, try it out on
some different dates and tiles.</p>
<p>Some other things to try:</p>
<ul class="simple">
<li>Write parts of the code as functions.</li>
<li>Put the code developed into a file and run it from the unix command
line.</li>
</ul>
</div>
<div class="section" id="a3-3-solar-radiation-model">
<h2>A3.3 Solar Radiation model<a class="headerlink" href="#a3-3-solar-radiation-model" title="Permalink to this headline">¶</a></h2>
<p>If you followed the advanced material for the previous chapter, you will
have noted the use of <tt class="docutils literal"><span class="pre">pyephem</span></tt> as a module that we can use for
calculating the solar zenith angle.</p>
<p>There is a similar package <tt class="docutils literal"><span class="pre">pysolar</span></tt> that is a little easier to use
for solar radiation calculations.</p>
<p>We will install a package <tt class="docutils literal"><span class="pre">pysolar</span></tt> into your user area:</p>
<p>at a unix prompt, type:</p>
<div class="code python highlight-python"><div class="highlight"><pre>!easy_install --user pysolar
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>Searching for pysolar
Best match: Pysolar 0.5
Processing Pysolar-0.5-py2.7.egg
Pysolar 0.5 is already the active version in easy-install.pth

Using /Users/plewis/.local/lib/python2.7/site-packages/Pysolar-0.5-py2.7.egg
Processing dependencies for pysolar
Finished processing dependencies for pysolar
</pre></div>
</div>
<p>If all goes well, the text that comes up at the terminal should tell you
that this has installed (e.g. in
<tt class="docutils literal"><span class="pre">/home/plewis/.local/lib/python2.7/site-packages/Pysolar-0.5-py2.7.egg</span></tt>).</p>
<p>We can test to see if we can load and run this package:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># from https://github.com/pingswept/pysolar/wiki/examples</span>
<span class="kn">import</span> <span class="nn">Pysolar</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c"># UCL lat/lon</span>
<span class="n">lat</span> <span class="o">=</span> <span class="mf">51.5248</span>
<span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1336</span>

<span class="n">hour</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">minute</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">second</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">month</span> <span class="o">=</span> <span class="mi">10</span> <span class="c"># ie October</span>
<span class="n">day</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">year</span> <span class="o">=</span> <span class="mi">2013</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
<span class="n">altitude_deg</span> <span class="o">=</span> <span class="n">Pysolar</span><span class="o">.</span><span class="n">GetAltitude</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="n">zenith</span> <span class="o">=</span> <span class="mf">90.</span> <span class="o">-</span> <span class="n">altitude_deg</span>
<span class="c"># W m^-2</span>
<span class="n">solar</span> <span class="o">=</span> <span class="n">Pysolar</span><span class="o">.</span><span class="n">solar</span><span class="o">.</span><span class="n">radiation</span><span class="o">.</span><span class="n">GetRadiationDirect</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">altitude_deg</span><span class="p">)</span>
<span class="k">print</span> <span class="n">zenith</span><span class="p">,</span><span class="n">solar</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>59.5052193764 834.866993323
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">solar</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">lat_deg</span><span class="p">,</span> <span class="n">lon_deg</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return solar zenith and clear sky radiation</span>
<span class="sd">       for given lat, lon and time/date</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
    <span class="kn">import</span> <span class="nn">Pysolar</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
    <span class="n">altitude_deg</span> <span class="o">=</span> <span class="n">Pysolar</span><span class="o">.</span><span class="n">GetAltitude</span><span class="p">(</span><span class="n">lat_deg</span><span class="p">,</span> <span class="n">lon_deg</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="c"># W m^-2</span>
    <span class="n">solar_rad</span> <span class="o">=</span> <span class="n">Pysolar</span><span class="o">.</span><span class="n">solar</span><span class="o">.</span><span class="n">radiation</span><span class="o">.</span><span class="n">GetRadiationDirect</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">altitude_deg</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">90.</span> <span class="o">-</span> <span class="n">altitude_deg</span><span class="p">,</span><span class="n">solar_rad</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># or import from local module</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>
<span class="c"># put local directory into the path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;files</span><span class="si">%s</span><span class="s">python&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">solar</span> <span class="kn">import</span> <span class="n">solar</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c"># UCL lat/lon</span>
<span class="n">lat</span> <span class="o">=</span> <span class="mf">51.5248</span>
<span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1336</span>

<span class="n">second</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">month</span> <span class="o">=</span> <span class="mi">10</span> <span class="c"># ie October</span>
<span class="n">day</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">year</span> <span class="o">=</span> <span class="mi">2013</span>

<span class="n">radiation_fields</span> <span class="o">=</span> <span class="s">&#39;#hour zenith solar_rad month day lat lon&#39;</span>

<span class="n">radiation</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">minute</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="n">hour</span> <span class="o">+</span> <span class="n">minute</span><span class="o">/</span><span class="mf">60.</span>
        <span class="c"># append data line as tuple</span>
        <span class="n">radiation</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">thr</span><span class="p">,)</span> <span class="o">+</span> \
                         <span class="n">solar</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">minute</span><span class="p">)</span> <span class="o">+</span>\
                         <span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">))</span>
<span class="c"># convert to numpy array</span>
<span class="c"># transpose so access eg zenith as</span>
<span class="c"># radiation[0]</span>
<span class="n">radiation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radiation</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># so we have radiation as</span>
<span class="k">print</span> <span class="n">radiation</span><span class="o">.</span><span class="n">shape</span>
<span class="k">print</span> <span class="n">radiation</span><span class="o">.</span><span class="n">ndim</span>
<span class="k">print</span> <span class="n">radiation</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>(7, 1440)
2
[[  0.00000000e+00   1.66666667e-02   3.33333333e-02 ...,   2.39500000e+01
    2.39666667e+01   2.39833333e+01]
 [  1.36158787e+02   1.36145826e+02   1.36131901e+02 ...,   1.36561804e+02
    1.36551449e+02   1.36540121e+02]
 [  0.00000000e+00   0.00000000e+00   0.00000000e+00 ...,   0.00000000e+00
    0.00000000e+00   0.00000000e+00]
 ...,
 [  1.30000000e+01   1.30000000e+01   1.30000000e+01 ...,   1.30000000e+01
    1.30000000e+01   1.30000000e+01]
 [  5.15248000e+01   5.15248000e+01   5.15248000e+01 ...,   5.15248000e+01
    5.15248000e+01   5.15248000e+01]
 [ -1.33600000e-01  -1.33600000e-01  -1.33600000e-01 ...,  -1.33600000e-01
   -1.33600000e-01  -1.33600000e-01]]
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Solar radiation at UCL&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;hour&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;solar radiation / Wm^-2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">radiation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">radiation</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>[&lt;matplotlib.lines.Line2D at 0x10681fed0&gt;]
</pre></div>
</div>
<img alt="../_images/advanced_66_1.png" src="../_images/advanced_66_1.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Solar zenith UCL&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;hour&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;solar zenith / degrees&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">radiation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">radiation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>[&lt;matplotlib.lines.Line2D at 0x1068bde50&gt;]
</pre></div>
</div>
<img alt="../_images/advanced_67_1.png" src="../_images/advanced_67_1.png" />
<p>E3.3 Exercise: Solar radiation modelling</p>
<p>This is a better modelling of solar radiation that we did in the main
part of the class today.</p>
<p>There are several things we could do with this.</p>
<p>For example, if we know the albedo, we can calculate the absorbed
radiation as previously done (if we assume for the moment albedo is
constant with solar zenith angle ... which it isn&#8217;t, generally), but can
now extend over the whole day and integrate to get the total energy per
metre squared.</p>
<p>From above, we have <a class="reference external" href="http://en.wikipedia.org/wiki/Watt">power</a> per
unit area, in Watts per metre squared.</p>
<p>This is the same as <a class="reference external" href="http://en.wikipedia.org/wiki/Joule">energy</a> per
unit area per second (i.e. the same as J/(m s)).</p>
<p>So if we sum up the solar radiation from above over the day and multiply
by the time interval in seconds (time interval above is 1 minute, so 60
seconds), we get:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">power_density</span> <span class="o">=</span> <span class="n">radiation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">60</span>
<span class="k">print</span> <span class="s">&#39;power per unit area = </span><span class="si">%.3f</span><span class="s"> MJ / m^2&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">power_density</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>power per unit area = 23.687 MJ / m^2
</pre></div>
</div>
<p>and we could now look at e.g. variations in this over the year (NB this
will take some time to calculate if you step every day and minute, so we
step every 30 minutes here):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">radiation</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span><span class="n">minute_step</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">minute</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="n">minute_step</span><span class="p">):</span>
            <span class="n">thr</span> <span class="o">=</span> <span class="n">hour</span> <span class="o">+</span> <span class="n">minute</span><span class="o">/</span><span class="mf">60.</span>
            <span class="c"># append data line as tuple</span>
            <span class="n">rad</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">thr</span><span class="p">,)</span> <span class="o">+</span> \
                     <span class="n">solar</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">minute</span><span class="p">)</span> <span class="o">+</span>\
                     <span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">))</span>
    <span class="c"># convert to numpy array</span>
    <span class="c"># transpose so access eg zenith as</span>
    <span class="c"># rad[0]</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">rad</span>

<span class="k">def</span> <span class="nf">days_in_month</span><span class="p">(</span><span class="n">month</span><span class="p">,</span><span class="n">year</span><span class="o">=</span><span class="mi">2013</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; number of days in month&#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">calendar</span>
    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="c"># UCL lat/lon</span>
<span class="n">lat</span> <span class="o">=</span> <span class="mf">51.5248</span>
<span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1336</span>

<span class="n">year</span> <span class="o">=</span> <span class="mi">2013</span>

<span class="n">minute_step</span> <span class="o">=</span> <span class="mi">30</span>

<span class="n">pd</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">ndays</span> <span class="o">=</span> <span class="n">days_in_month</span><span class="p">(</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">month</span><span class="p">,</span><span class="n">ndays</span>
    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">ndays</span><span class="p">):</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">radiation</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span><span class="n">minute_step</span><span class="o">=</span><span class="n">minute_step</span><span class="p">)</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">month</span><span class="o">+</span><span class="n">day</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ndays</span><span class="p">),</span><span class="n">rad</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">minute_step</span><span class="p">])</span>
<span class="n">pd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>0 31
1 28
2 31
3 30
4 31
5 30
6 31
7 31
8 30
9 31
10 30
11 31
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Power per unit area, UCL&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;month&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Power per unit area / MJ m^-2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>[&lt;matplotlib.lines.Line2D at 0x106abdc50&gt;]
</pre></div>
</div>
<img alt="../_images/advanced_73_1.png" src="../_images/advanced_73_1.png" />
<p>or, if we want to sum over a month:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># UCL lat/lon</span>
<span class="n">lat</span> <span class="o">=</span> <span class="mf">51.5248</span>
<span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1336</span>

<span class="n">year</span> <span class="o">=</span> <span class="mi">2013</span>

<span class="n">pd</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">pd_month</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ndays</span> <span class="o">=</span> <span class="n">days_in_month</span><span class="p">(</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">month</span><span class="p">,</span><span class="n">ndays</span>
    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">ndays</span><span class="p">):</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">radiation</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
        <span class="n">pd_month</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">rad</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">30</span><span class="p">])</span>
    <span class="n">pd_month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd_month</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">month</span><span class="p">,</span><span class="n">pd_month</span><span class="o">.</span><span class="n">sum</span><span class="p">()])</span>
<span class="n">pd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>0 31
1 28
2 31
3 30
4 31
5 30
6 31
7 31
8 30
9 31
10 30
11 31
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Monthly total Power per unit area, UCL&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;month&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Power per unit area / MJ m^-2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>[&lt;matplotlib.lines.Line2D at 0x107234d10&gt;]
</pre></div>
</div>
<img alt="../_images/advanced_76_1.png" src="../_images/advanced_76_1.png" />
</div>
<div class="section" id="e3-3-improved-solar-radiation-modelling">
<h2>E3.3 Improved Solar Radiation Modelling<a class="headerlink" href="#e3-3-improved-solar-radiation-modelling" title="Permalink to this headline">¶</a></h2>
<p>Using the material above and the global albedo datasets from the main
class material, <strong>calculate an improved estimate of the total absorbed
power per unit area per month (MJ per m^2 per month) for the Earth land
surface</strong>.</p>
<p>You should do this with a function that will take as input the year and
returns the monthly total absorbed power density (MJ m^-2 per month) and
the monthly total power density (MJ m^-2 per month).</p>
<p>You might have an optional argument <tt class="docutils literal"><span class="pre">minute_step</span></tt> to control the
resolution of the calculation as above.</p>
<p>You could then use this to derive latitudinal variations in annual and
latitudinal total absorbed power per unit area.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html" title="index">
          <img class="logo" src="../_static/ucl_logo.png" alt="Logo"/>
        </a></p><div class="sphinxlocaltoc">
    <h3><a href="../index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">A3. Advanced notes: Scientific and Numerical Python</a><ul>
<li><a class="reference internal" href="#a3-1-pulling-compressed-netcdf-files">A3.1 Pulling Compressed netCDF Files</a><ul>
<li><a class="reference internal" href="#doing-this-in-python">Doing this in Python</a></li>
<li><a class="reference internal" href="#doing-this-in-unix">Doing this in unix</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a3-2-logical-combinations-in-numpy">A3.2 Logical combinations in numpy</a></li>
<li><a class="reference internal" href="#a3-3-solar-radiation-model">A3.3 Solar Radiation model</a></li>
<li><a class="reference internal" href="#e3-3-improved-solar-radiation-modelling">E3.3 Improved Solar Radiation Modelling</a></li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="../Chapter2_Python_intro/main_answers.html"
                          title="Previous page">&larr; E2. Exercises</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="advanced_answers.html"
                          title="Next page">&rarr; E3.3: Exercise: Improved Solar Radiation Modelling</a></p>
  </div>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/Chapter3_Scientific_Numerical_Python/advanced.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="advanced_answers.html" title="E3.3: Exercise: Improved Solar Radiation Modelling"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../Chapter2_Python_intro/main_answers.html" title="E2. Exercises"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">geogg122</a> &raquo;</li>
 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2014, Prof. P. Lewis.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>